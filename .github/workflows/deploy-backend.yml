name: Deploy Backend

on:
  # Trigger after CI Backend completes successfully
  workflow_run:
    workflows: ["CI Backend"]
    types: [completed]
    branches: [main]
  # Production: version tags
  push:
    tags:
      - 'v*'
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        default: 'beta'
        type: choice
        options:
          - beta
          - prod

env:
  REGISTRY: rg.nl-ams.scw.cloud/ash-backend
  IMAGE_NAME: ash-backend

jobs:
  # Determine deployment target
  setup:
    name: Setup
    runs-on: ubuntu-latest
    # Skip if triggered by workflow_run and CI failed
    if: |
      github.event_name != 'workflow_run' ||
      github.event.workflow_run.conclusion == 'success'
    outputs:
      environment: ${{ steps.env.outputs.environment }}
      image_tag: ${{ steps.env.outputs.image_tag }}
      should_deploy: ${{ steps.env.outputs.should_deploy }}

    steps:
      - name: Determine environment and tag
        id: env
        run: |
          # Manual dispatch
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "environment=${{ inputs.environment }}" >> $GITHUB_OUTPUT
            echo "image_tag=sha-${GITHUB_SHA::7}" >> $GITHUB_OUTPUT
            echo "should_deploy=true" >> $GITHUB_OUTPUT
          # GitHub Release -> prod
          elif [ "${{ github.event_name }}" = "release" ]; then
            TAG="${{ github.event.release.tag_name }}"
            echo "environment=prod" >> $GITHUB_OUTPUT
            echo "image_tag=${TAG}" >> $GITHUB_OUTPUT
            echo "should_deploy=true" >> $GITHUB_OUTPUT
          # Version tag push -> prod
          elif [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            TAG="${{ github.ref_name }}"
            echo "environment=prod" >> $GITHUB_OUTPUT
            echo "image_tag=${TAG}" >> $GITHUB_OUTPUT
            echo "should_deploy=true" >> $GITHUB_OUTPUT
          # Triggered by CI Backend workflow_run -> beta
          elif [ "${{ github.event_name }}" = "workflow_run" ]; then
            SHA="${{ github.event.workflow_run.head_sha }}"
            echo "environment=beta" >> $GITHUB_OUTPUT
            echo "image_tag=sha-${SHA::7}" >> $GITHUB_OUTPUT
            echo "should_deploy=true" >> $GITHUB_OUTPUT
          # Push to main -> beta (fallback, shouldn't happen with new triggers)
          elif [ "${{ github.ref }}" = "refs/heads/main" ]; then
            echo "environment=beta" >> $GITHUB_OUTPUT
            echo "image_tag=sha-${GITHUB_SHA::7}" >> $GITHUB_OUTPUT
            echo "should_deploy=true" >> $GITHUB_OUTPUT
          else
            echo "should_deploy=false" >> $GITHUB_OUTPUT
          fi

      - name: Summary
        run: |
          echo "### Deployment Setup" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment:** ${{ steps.env.outputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Image Tag:** ${{ steps.env.outputs.image_tag }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Trigger:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY

  # Build binaries (only for manual dispatch or tag push)
  build-linux-amd64:
    name: Build Binary (amd64)
    runs-on: ubuntu-latest
    needs: setup
    if: |
      needs.setup.outputs.should_deploy == 'true' &&
      github.event_name != 'workflow_run'
    defaults:
      run:
        working-directory: backend
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Restore cargo cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            backend/target/
          key: ${{ runner.os }}-cargo-backend-release-${{ hashFiles('backend/Cargo.lock') }}
          restore-keys: ${{ runner.os }}-cargo-backend-release-

      - name: Build release binary
        run: cargo build --release --locked

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ash-backend-linux-amd64
          path: backend/target/release/ash-backend
          retention-days: 7

  build-linux-arm64:
    name: Build Binary (arm64)
    runs-on: ubuntu-24.04-arm
    needs: setup
    if: |
      needs.setup.outputs.should_deploy == 'true' &&
      github.event_name != 'workflow_run'
    defaults:
      run:
        working-directory: backend
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Restore cargo cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            backend/target/
          key: ${{ runner.os }}-${{ runner.arch }}-cargo-backend-release-${{ hashFiles('backend/Cargo.lock') }}
          restore-keys: ${{ runner.os }}-${{ runner.arch }}-cargo-backend-release-

      - name: Build release binary
        run: cargo build --release --locked

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ash-backend-linux-arm64
          path: backend/target/release/ash-backend
          retention-days: 7

  # Build and push Docker images
  docker:
    name: Build & Push Docker
    needs: [setup, build-linux-amd64, build-linux-arm64]
    if: |
      always() &&
      needs.setup.outputs.should_deploy == 'true' &&
      needs.setup.result == 'success' &&
      (needs.build-linux-amd64.result == 'success' || needs.build-linux-amd64.result == 'skipped') &&
      (needs.build-linux-arm64.result == 'success' || needs.build-linux-arm64.result == 'skipped')
    uses: ./.github/workflows/docker-backend.yml
    with:
      image_tag: ${{ needs.setup.outputs.image_tag }}
      push: true
      artifact_run_id: ${{ github.event.workflow_run.id || github.run_id }}
      environment: ${{ needs.setup.outputs.environment }}
    secrets: inherit

  # Deploy to Scaleway (Blue-Green)
  deploy:
    name: Deploy (${{ needs.setup.outputs.environment }})
    needs: [setup, docker]
    runs-on: ubuntu-latest
    environment: ${{ needs.setup.outputs.environment }}

    env:
      SCW_ACCESS_KEY: ${{ secrets.SCW_ACCESS_KEY }}
      SCW_SECRET_KEY: ${{ secrets.SCW_SECRET_KEY }}
      SCW_DEFAULT_PROJECT_ID: ${{ vars.SCW_DEFAULT_PROJECT_ID }}
      SCW_DEFAULT_ORGANIZATION_ID: ${{ vars.SCW_DEFAULT_ORGANIZATION_ID }}
      AWS_ACCESS_KEY_ID: ${{ secrets.SCW_ACCESS_KEY }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.SCW_SECRET_KEY }}
      # Cloudflare for DNS
      CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
      TF_VAR_cloudflare_api_token: ${{ secrets.CLOUDFLARE_API_TOKEN }}
      TF_VAR_cloudflare_zone_id: ${{ vars.CLOUDFLARE_ZONE_ID }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_sha || github.sha }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.7.0"
          terraform_wrapper: false

      - name: Terraform Init
        working-directory: infra/scaleway
        run: |
          terraform init \
            -backend-config="key=scaleway/${{ needs.setup.outputs.environment }}/terraform.tfstate"

      - name: Determine active slot (Blue-Green)
        id: slot
        working-directory: infra/scaleway
        run: |
          # Get current active slot from state, default to blue if not set
          CURRENT_SLOT=$(terraform output -raw active_slot 2>/dev/null || echo "blue")

          # Flip to the other slot for this deployment
          if [ "$CURRENT_SLOT" = "blue" ]; then
            NEW_SLOT="green"
          else
            NEW_SLOT="blue"
          fi

          echo "current_slot=$CURRENT_SLOT" >> $GITHUB_OUTPUT
          echo "new_slot=$NEW_SLOT" >> $GITHUB_OUTPUT
          echo "Switching from $CURRENT_SLOT to $NEW_SLOT"

      - name: Terraform Plan (Blue-Green)
        working-directory: infra/scaleway
        run: |
          terraform plan \
            -var-file="environments/${{ needs.setup.outputs.environment }}.tfvars" \
            -var="image_tag=${{ needs.setup.outputs.image_tag }}" \
            -var="active_slot=${{ steps.slot.outputs.new_slot }}" \
            -out=tfplan

      - name: Terraform Apply
        working-directory: infra/scaleway
        run: terraform apply -auto-approve tfplan

      - name: Health Check
        working-directory: infra/scaleway
        run: |
          echo "Waiting for deployment to stabilize..."
          sleep 30

          # Get relay URL from Terraform output
          RELAY_URL=$(terraform output -raw relay_url 2>/dev/null || echo "")

          if [ -n "$RELAY_URL" ]; then
            echo "Checking health at ${RELAY_URL}/health"
            # Retry a few times as DNS/SSL might take a moment
            for i in 1 2 3 4 5; do
              if curl -sf "${RELAY_URL}/health"; then
                echo "Health check passed!"
                exit 0
              fi
              echo "Attempt $i failed, retrying in 10s..."
              sleep 10
            done
            echo "Health check failed after 5 attempts"
            exit 1
          fi

      - name: Summary
        working-directory: infra/scaleway
        run: |
          RELAY_URL=$(terraform output -raw relay_url 2>/dev/null || echo "N/A")
          CUSTOM_DOMAIN=$(terraform output -raw custom_domain 2>/dev/null || echo "N/A")
          ACTIVE_SLOT=$(terraform output -raw active_slot 2>/dev/null || echo "N/A")
          echo "### Deployment Complete (Blue-Green)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Setting | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Environment** | ${{ needs.setup.outputs.environment }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Active Slot** | ðŸŸ¢ ${ACTIVE_SLOT} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Previous Slot** | ${{ steps.slot.outputs.current_slot }} (destroyed) |" >> $GITHUB_STEP_SUMMARY
          echo "| **Image Tag** | \`${{ needs.setup.outputs.image_tag }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Relay URL** | ${RELAY_URL} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Domain** | \`${CUSTOM_DOMAIN}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Region** | nl-ams |" >> $GITHUB_STEP_SUMMARY
