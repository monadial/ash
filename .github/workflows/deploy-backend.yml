name: Deploy Backend

on:
  # Trigger after CI Backend completes successfully (main branch or tags)
  workflow_run:
    workflows: ["CI Backend"]
    types: [completed]
  # Production: GitHub Release publishes
  release:
    types: [published]

env:
  REGISTRY: rg.nl-ams.scw.cloud/ash-backend
  IMAGE_NAME: ash-backend

jobs:
  # Determine deployment target
  setup:
    name: Setup
    runs-on: ubuntu-latest
    # Skip if triggered by workflow_run and CI failed
    if: |
      github.event_name != 'workflow_run' ||
      github.event.workflow_run.conclusion == 'success'
    outputs:
      environment: ${{ steps.env.outputs.environment }}
      image_tag: ${{ steps.env.outputs.image_tag }}
      should_deploy: ${{ steps.env.outputs.should_deploy }}

    steps:
      - name: Determine environment and tag
        id: env
        run: |
          # GitHub Release -> prod
          if [ "${{ github.event_name }}" = "release" ]; then
            TAG="${{ github.event.release.tag_name }}"
            echo "environment=prod" >> $GITHUB_OUTPUT
            echo "image_tag=${TAG}" >> $GITHUB_OUTPUT
            echo "should_deploy=true" >> $GITHUB_OUTPUT
          # Triggered by CI Backend workflow_run
          elif [ "${{ github.event_name }}" = "workflow_run" ]; then
            SHA="${{ github.event.workflow_run.head_sha }}"
            REF="${{ github.event.workflow_run.head_branch }}"
            EVENT="${{ github.event.workflow_run.event }}"

            # Skip PR runs - only deploy from push events
            if [ "$EVENT" = "pull_request" ]; then
              echo "Skipping deployment for PR"
              echo "should_deploy=false" >> $GITHUB_OUTPUT
              exit 0
            fi

            # Check if this was triggered by a version tag (v*)
            if [[ "$REF" == v* ]]; then
              echo "environment=prod" >> $GITHUB_OUTPUT
              echo "image_tag=${REF}" >> $GITHUB_OUTPUT
              echo "should_deploy=true" >> $GITHUB_OUTPUT
            # Main branch -> beta
            elif [ "$REF" = "main" ]; then
              echo "environment=beta" >> $GITHUB_OUTPUT
              echo "image_tag=sha-${SHA::7}" >> $GITHUB_OUTPUT
              echo "should_deploy=true" >> $GITHUB_OUTPUT
            else
              echo "Skipping deployment for branch: $REF"
              echo "should_deploy=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "should_deploy=false" >> $GITHUB_OUTPUT
          fi

      - name: Summary
        run: |
          echo "### Deployment Setup" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment:** ${{ steps.env.outputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Image Tag:** ${{ steps.env.outputs.image_tag }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Trigger:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY

  # Build and push Docker images
  docker:
    name: Build & Push Docker
    needs: setup
    if: needs.setup.outputs.should_deploy == 'true'
    uses: ./.github/workflows/docker-backend.yml
    with:
      image_tag: ${{ needs.setup.outputs.image_tag }}
      push: true
      artifact_run_id: ${{ github.event.workflow_run.id }}
      environment: ${{ needs.setup.outputs.environment }}
    secrets: inherit

  # Deploy to Scaleway (Blue-Green)
  deploy:
    name: Deploy (${{ needs.setup.outputs.environment }})
    needs: [setup, docker]
    runs-on: ubuntu-latest
    environment: ${{ needs.setup.outputs.environment }}

    env:
      SCW_ACCESS_KEY: ${{ secrets.SCW_ACCESS_KEY }}
      SCW_SECRET_KEY: ${{ secrets.SCW_SECRET_KEY }}
      SCW_DEFAULT_PROJECT_ID: ${{ vars.SCW_DEFAULT_PROJECT_ID }}
      SCW_DEFAULT_ORGANIZATION_ID: ${{ vars.SCW_DEFAULT_ORGANIZATION_ID }}
      AWS_ACCESS_KEY_ID: ${{ secrets.SCW_ACCESS_KEY }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.SCW_SECRET_KEY }}
      # Cloudflare for DNS
      CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
      TF_VAR_cloudflare_api_token: ${{ secrets.CLOUDFLARE_API_TOKEN }}
      TF_VAR_cloudflare_zone_id: ${{ vars.CLOUDFLARE_ZONE_ID }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_sha || github.sha }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.7.0"
          terraform_wrapper: false

      - name: Terraform Init
        working-directory: infra/scaleway
        run: |
          terraform init \
            -backend-config="key=scaleway/${{ needs.setup.outputs.environment }}/terraform.tfstate"

      - name: Determine active slot (Blue-Green)
        id: slot
        working-directory: infra/scaleway
        run: |
          # Get current active slot from state, default to blue if not set
          CURRENT_SLOT=$(terraform output -raw active_slot 2>/dev/null || echo "blue")

          # Flip to the other slot for this deployment
          if [ "$CURRENT_SLOT" = "blue" ]; then
            NEW_SLOT="green"
          else
            NEW_SLOT="blue"
          fi

          echo "current_slot=$CURRENT_SLOT" >> $GITHUB_OUTPUT
          echo "new_slot=$NEW_SLOT" >> $GITHUB_OUTPUT
          echo "Switching from $CURRENT_SLOT to $NEW_SLOT"

      - name: Terraform Plan (Blue-Green)
        working-directory: infra/scaleway
        run: |
          terraform plan \
            -var-file="environments/${{ needs.setup.outputs.environment }}.tfvars" \
            -var="image_tag=${{ needs.setup.outputs.image_tag }}" \
            -var="active_slot=${{ steps.slot.outputs.new_slot }}" \
            -out=tfplan

      - name: Terraform Apply
        working-directory: infra/scaleway
        run: terraform apply -auto-approve tfplan

      - name: Health Check
        working-directory: infra/scaleway
        run: |
          echo "Waiting for deployment to stabilize..."
          sleep 30

          # Get relay URL from Terraform output
          RELAY_URL=$(terraform output -raw relay_url 2>/dev/null || echo "")

          if [ -n "$RELAY_URL" ]; then
            echo "Checking health at ${RELAY_URL}/health"
            # Retry a few times as DNS/SSL might take a moment
            for i in 1 2 3 4 5; do
              if curl -sf "${RELAY_URL}/health"; then
                echo "Health check passed!"
                exit 0
              fi
              echo "Attempt $i failed, retrying in 10s..."
              sleep 10
            done
            echo "Health check failed after 5 attempts"
            exit 1
          fi

      - name: Summary
        working-directory: infra/scaleway
        run: |
          RELAY_URL=$(terraform output -raw relay_url 2>/dev/null || echo "N/A")
          CUSTOM_DOMAIN=$(terraform output -raw custom_domain 2>/dev/null || echo "N/A")
          ACTIVE_SLOT=$(terraform output -raw active_slot 2>/dev/null || echo "N/A")
          echo "### Deployment Complete (Blue-Green)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Setting | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Environment** | ${{ needs.setup.outputs.environment }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Active Slot** | ðŸŸ¢ ${ACTIVE_SLOT} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Previous Slot** | ${{ steps.slot.outputs.current_slot }} (destroyed) |" >> $GITHUB_STEP_SUMMARY
          echo "| **Image Tag** | \`${{ needs.setup.outputs.image_tag }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Relay URL** | ${RELAY_URL} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Domain** | \`${CUSTOM_DOMAIN}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Region** | nl-ams |" >> $GITHUB_STEP_SUMMARY
