---
import Layout from '../layouts/Layout.astro'
import TableOfContents from '../components/TableOfContents.astro'
import Diagram from '../components/Diagram.astro'
import InfoBox from '../components/InfoBox.astro'
import WhitepaperViewToggle from '../components/WhitepaperViewToggle.tsx'
import OTPDemo from '../components/OTPDemo.tsx'
import PaddingDemo from '../components/PaddingDemo.tsx'
import MnemonicDemo from '../components/MnemonicDemo.tsx'
import TokenDemo from '../components/TokenDemo.tsx'
import PolyHashDemo from '../components/PolyHashDemo.tsx'
import MessagePipelineDemo from '../components/MessagePipelineDemo.tsx'

const tocItems = [
  { id: 'abstract', title: 'Abstract' },
  { id: 'overview', title: '1. Protocol Overview', children: [
    { id: 'otp', title: '1.1 One-Time Pad' },
    { id: 'shannon', title: '1.2 Perfect Secrecy' },
  ]},
  { id: 'architecture', title: '2. System Architecture', children: [
    { id: 'core', title: '2.1 Cryptographic Core' },
    { id: 'apps', title: '2.2 Mobile Applications' },
    { id: 'backend', title: '2.3 Backend Relay' },
  ]},
  { id: 'ceremony', title: '3. Key Establishment', children: [
    { id: 'ceremony-flow', title: '3.1 Ceremony Flow' },
    { id: 'passphrase', title: '3.2 Passphrase Protection' },
    { id: 'mnemonic', title: '3.3 Mnemonic Verification' },
    { id: 'pad-sizes', title: '3.4 Pad Sizes' },
  ]},
  { id: 'framing', title: '4. Frame Format', children: [
    { id: 'basic-frame', title: '4.1 Basic Frame' },
    { id: 'extended-frame', title: '4.2 Extended Frame' },
  ]},
  { id: 'messages', title: '5. Messaging Protocol', children: [
    { id: 'message-frame', title: '5.1 Message Frame' },
    { id: 'encryption-flow', title: '5.2 Processing Pipeline' },
    { id: 'authentication', title: '5.3 Authentication' },
    { id: 'bidirectional', title: '5.4 Pad Consumption' },
    { id: 'message-types', title: '5.5 Message Types' },
  ]},
  { id: 'tokens', title: '6. Token Derivation' },
  { id: 'trust', title: '7. Trust Model' },
  { id: 'glossary', title: 'Glossary' },
  { id: 'sources', title: 'References' },
  { id: 'changelog', title: 'Revision History' },
  { id: 'feedback', title: 'Feedback' },
]
---

<Layout title="Whitepaper" description="ASH Protocol technical specification. One-Time Pad encryption, ceremony protocol, and frame format.">
  <div class="py-16 sm:py-24">
    <!-- Document Header -->
    <div class="text-center mb-12">
      <h1 class="text-4xl sm:text-5xl font-bold mb-4">ASH Protocol Specification</h1>
      <p class="text-text-secondary text-lg max-w-2xl mx-auto mb-8">
        Information-Theoretic Secure Messaging Using One-Time Pad Encryption
      </p>

      <!-- Document Metadata -->
      <div class="inline-flex flex-wrap justify-center gap-4 text-sm mb-6">
        <div class="flex items-center gap-2 px-3 py-1.5 bg-bg-card border border-border rounded-lg">
          <span class="text-text-muted">Version:</span>
          <span class="text-white font-mono">1.0.0-draft</span>
        </div>
        <div class="flex items-center gap-2 px-3 py-1.5 bg-bg-card border border-border rounded-lg">
          <span class="text-text-muted">Date:</span>
          <span class="text-white font-mono">2025-01-22</span>
        </div>
        <div class="flex items-center gap-2 px-3 py-1.5 bg-warning/10 border border-warning/30 rounded-lg">
          <span class="text-warning">Status:</span>
          <span class="text-warning font-medium">Draft for Review</span>
        </div>
      </div>

      <!-- View Toggle -->
      <div class="flex justify-center">
        <WhitepaperViewToggle client:load />
      </div>
    </div>

    <!-- CSS for view modes -->
    <style is:global>
      .professional-mode .demo-section {
        display: none !important;
      }
      .interactive-mode .demo-section {
        display: block;
      }
    </style>

    <!-- Main content with TOC -->
    <div class="lg:grid lg:grid-cols-[240px_1fr] lg:gap-12">
      <!-- Table of Contents (sticky sidebar) -->
      <aside class="hidden lg:block">
        <TableOfContents items={tocItems} />
      </aside>

      <!-- Content -->
      <article class="prose-content space-y-16">
        <!-- Abstract -->
        <section id="abstract">
          <h2 class="text-2xl font-bold mb-6 pb-2 border-b border-border">Abstract</h2>
          <div class="text-text-secondary space-y-4">
            <p>
              This document specifies ASH (Anonymous Secure Handoff), a secure messaging protocol designed for high-security, low-frequency communication. ASH provides <strong class="text-white">information-theoretic security</strong> — cryptographic guarantees that hold regardless of an adversary's computational power, including quantum computers.
            </p>
            <p>
              The protocol employs One-Time Pad (OTP) encryption for confidentiality and Wegman-Carter polynomial hashing for authentication. Key establishment occurs through an in-person ceremony using QR codes, eliminating reliance on public-key infrastructure or trusted third parties. A stateless relay server stores only encrypted blobs in RAM, providing message delivery without access to plaintext.
            </p>
            <p>
              ASH explicitly trades convenience for security: no key recovery, no cloud backup, no multi-device sync, no account system. These constraints are fundamental to the security model. The protocol is suitable for scenarios requiring provable security guarantees, including whistleblowing, journalism source protection, and high-value business communications.
            </p>
          </div>

          <div class="mt-6 grid sm:grid-cols-3 gap-4">
            <div class="bg-bg-card border border-border rounded-lg p-4">
              <div class="text-xs text-text-muted uppercase tracking-wider mb-1">Encryption</div>
              <div class="text-white font-medium">One-Time Pad (XOR)</div>
              <div class="text-text-secondary text-sm">Perfect secrecy</div>
            </div>
            <div class="bg-bg-card border border-border rounded-lg p-4">
              <div class="text-xs text-text-muted uppercase tracking-wider mb-1">Authentication</div>
              <div class="text-white font-medium">Wegman-Carter MAC</div>
              <div class="text-text-secondary text-sm">256-bit, GF(2^128)</div>
            </div>
            <div class="bg-bg-card border border-border rounded-lg p-4">
              <div class="text-xs text-text-muted uppercase tracking-wider mb-1">Key Exchange</div>
              <div class="text-white font-medium">In-Person Ceremony</div>
              <div class="text-text-secondary text-sm">QR + passphrase</div>
            </div>
          </div>
        </section>

        <!-- Section 1: Protocol Overview -->
        <section id="overview">
          <h2 class="text-2xl font-bold mb-6 pb-2 border-b border-border">1. Protocol Overview</h2>

          <div id="otp" class="mb-8">
            <h3 class="text-xl font-semibold mb-4">1.1 One-Time Pad Encryption</h3>
            <p class="text-text-secondary mb-4">
              ASH uses the One-Time Pad (OTP) cipher, the only encryption method proven to provide <strong class="text-white">information-theoretic security</strong>. Unlike computational security (used by AES, RSA, and modern cryptography), OTP security does not depend on mathematical assumptions or computational hardness.
            </p>
            <p class="text-text-secondary mb-4">
              The encryption is simple: each message byte is XOR'd with a corresponding key byte that is:
            </p>
            <ul class="list-disc list-inside text-text-secondary mb-4 space-y-1">
              <li>Truly random (from entropy sources)</li>
              <li>As long as the message</li>
              <li>Never reused (consumed after use)</li>
              <li>Known only to the two parties</li>
            </ul>

            <Diagram title="OTP Encryption">
{`Plaintext:  H   E   L   L   O      (message bytes)
               ⊕   ⊕   ⊕   ⊕   ⊕      (XOR operation)
Key:        7   K   2   X   9      (random key bytes)
               =   =   =   =   =
Ciphertext: ?   ?   ?   ?   ?      (encrypted bytes)`}
            </Diagram>

            <div class="demo-section mt-6">
              <h4 class="font-medium mb-3">Try It Yourself</h4>
              <p class="text-text-secondary text-sm mb-4">
                This interactive demo uses the actual ASH Rust cryptographic core compiled to WebAssembly.
                Type a message and see how XOR encryption works byte-by-byte.
              </p>
              <OTPDemo client:load />
            </div>
          </div>

          <div id="shannon" class="mb-8">
            <h3 class="text-xl font-semibold mb-4">1.2 Shannon's Perfect Secrecy</h3>
            <p class="text-text-secondary mb-4">
              In 1949, Claude Shannon mathematically proved that OTP provides "perfect secrecy": the ciphertext reveals absolutely nothing about the plaintext to an attacker without the key.
            </p>

            <InfoBox>
              <p class="text-sm">
                <strong class="text-white">Formal definition:</strong> A cipher has perfect secrecy if for all plaintexts M and ciphertexts C: P(M|C) = P(M). The probability of any plaintext given the ciphertext equals its prior probability.
              </p>
            </InfoBox>

            <p class="text-text-secondary mt-4">
              This means that without the key, every possible plaintext is equally likely. "HELLO" could decrypt to "WORLD", "PIZZA", or any other 5-letter combination. No amount of computation—not even quantum computers—can determine the original message.
            </p>
          </div>
        </section>

        <!-- Section 2: System Architecture -->
        <section id="architecture">
          <h2 class="text-2xl font-bold mb-6 pb-2 border-b border-border">2. System Architecture</h2>

          <p class="text-text-secondary mb-6">
            ASH consists of four primary subsystems with explicitly defined trust boundaries. Security emerges from clear component separation and minimal infrastructure trust.
          </p>

          <Diagram title="System Overview">
{`┌────────────┐
│   Users    │
└─────┬──────┘
      │
┌─────▼──────┐
│  iOS App   │  (SwiftUI presentation layer)
└─────┬──────┘
      │  FFI boundary (UniFFI bindings)
┌─────▼──────┐
│   core     │  (Shared Rust Core - cryptographic authority)
└─────┬──────┘
      │
┌─────▼──────┐
│  Backend   │  (Rust Relay - stateless, untrusted)
└────────────┘`}
          </Diagram>

          <div id="core" class="mt-8 mb-8">
            <h3 class="text-xl font-semibold mb-4">2.1 Cryptographic Core (ash-core)</h3>
            <p class="text-text-secondary mb-4">
              The core is the <strong class="text-white">cryptographic and procedural authority</strong> of ASH. All security-sensitive behavior is defined here, and all other components must treat it as authoritative.
            </p>

            <div class="bg-bg-card border border-border rounded-lg overflow-hidden mb-4">
              <div class="px-4 py-2 border-b border-border bg-bg-elevated">
                <span class="text-xs font-medium text-text-secondary">Core Responsibilities</span>
              </div>
              <ul class="p-4 space-y-2 text-sm text-text-secondary">
                <li>• One-Time Pad creation and management</li>
                <li>• Strict pad single-use semantics enforcement</li>
                <li>• Bidirectional pad consumption (Initiator/Responder)</li>
                <li>• OTP encryption and decryption</li>
                <li>• <strong class="text-white">Wegman-Carter 256-bit message authentication</strong></li>
                <li>• <strong class="text-white">GF(2^128) polynomial hashing</strong></li>
                <li>• <strong class="text-white">Mandatory 32-byte message padding</strong></li>
                <li>• Ceremony rules and frame encoding/decoding</li>
                <li>• CRC-32 integrity validation</li>
                <li>• Authorization token derivation</li>
                <li>• Mnemonic checksum generation (6 words, 512-word wordlist)</li>
                <li>• Best-effort memory wiping</li>
              </ul>
            </div>

            <InfoBox variant="warning">
              <p class="text-sm">
                <strong>ash-core must never:</strong> access the network, perform I/O, access OS randomness directly, contain platform-specific code, store data, include UI logic, or log sensitive data.
              </p>
            </InfoBox>
          </div>

          <div id="apps" class="mb-8">
            <h3 class="text-xl font-semibold mb-4">2.2 Mobile Applications</h3>
            <p class="text-text-secondary mb-4">
              The iOS application (Android planned) is a <strong class="text-white">presentation and orchestration layer</strong>. It invokes core functionality via UniFFI-generated Swift bindings and manages the user interface.
            </p>
            <p class="text-text-secondary mb-4">
              Mobile apps must never: reimplement cryptographic logic, alter OTP behavior, bypass the shared core, invent alternate checksums, persist decrypted messages, or perform silent background actions.
            </p>
          </div>

          <div id="backend" class="mb-8">
            <h3 class="text-xl font-semibold mb-4">2.3 Backend Relay</h3>
            <p class="text-text-secondary mb-4">
              The backend is a <strong class="text-white">stateless RAM-only relay</strong>. It is intentionally simple and considered untrusted. Messages are held only in memory until ACK or TTL expiry.
            </p>

            <Diagram title="Message Flow">
{`Alice                    Server (RAM)                    Bob
  │                          │                              │
  │  POST /v1/messages       │                              │
  ├─────────────────────────►│  (store, start TTL)          │
  │◄── {blob_id} ────────────│                              │
  │                          │───── SSE: message ──────────►│
  │                          │                     (decrypt) │
  │                          │◄─── POST /v1/ack ────────────│
  │◄── SSE: delivered ───────│  (delete from RAM)           │`}
            </Diagram>

            <p class="text-text-secondary mt-4">
              Backend must never: persist messages to disk, decrypt messages, inspect payload contents, identify users, store data long-term, or implement business logic.
            </p>
          </div>
        </section>

        <!-- Section 3: Key Establishment -->
        <section id="ceremony">
          <h2 class="text-2xl font-bold mb-6 pb-2 border-b border-border">3. Key Establishment Protocol</h2>

          <p class="text-text-secondary mb-6">
            The ceremony establishes a shared One-Time Pad between two devices through physical proximity. It is designed to be <strong class="text-white">offline</strong>, <strong class="text-white">explicit</strong>, <strong class="text-white">human-verifiable</strong>, and <strong class="text-white">atomic</strong>. No network communication occurs during key generation.
          </p>

          <div id="ceremony-flow" class="mb-8">
            <h3 class="text-xl font-semibold mb-4">3.1 Ceremony Flow</h3>

            <div class="bg-bg-card border border-border rounded-lg overflow-hidden">
              <div class="divide-y divide-border">
                <div class="p-4">
                  <div class="flex items-start gap-4">
                    <span class="shrink-0 w-8 h-8 bg-brand rounded-lg flex items-center justify-center text-white font-bold text-sm">1</span>
                    <div>
                      <h4 class="font-medium mb-1">Pad Size Selection</h4>
                      <p class="text-text-secondary text-sm">Sender selects pad size via slider, determining message capacity and ceremony duration.</p>
                    </div>
                  </div>
                </div>
                <div class="p-4">
                  <div class="flex items-start gap-4">
                    <span class="shrink-0 w-8 h-8 bg-brand rounded-lg flex items-center justify-center text-white font-bold text-sm">2</span>
                    <div>
                      <h4 class="font-medium mb-1">Entropy Collection</h4>
                      <p class="text-text-secondary text-sm">OS randomness mixed with required gesture input. User draws patterns while entropy accumulates visually.</p>
                    </div>
                  </div>
                </div>
                <div class="p-4">
                  <div class="flex items-start gap-4">
                    <span class="shrink-0 w-8 h-8 bg-brand rounded-lg flex items-center justify-center text-white font-bold text-sm">3</span>
                    <div>
                      <h4 class="font-medium mb-1">Passphrase Exchange</h4>
                      <p class="text-text-secondary text-sm">Both parties agree on a shared passphrase (minimum 4 characters). This encrypts QR frames to protect against visual observation.</p>
                    </div>
                  </div>
                </div>
                <div class="p-4">
                  <div class="flex items-start gap-4">
                    <span class="shrink-0 w-8 h-8 bg-brand rounded-lg flex items-center justify-center text-white font-bold text-sm">4</span>
                    <div>
                      <h4 class="font-medium mb-1">QR Transfer</h4>
                      <p class="text-text-secondary text-sm">Sender displays passphrase-encrypted QR codes. Receiver scans frames, decrypts, validates CRC, and acknowledges.</p>
                    </div>
                  </div>
                </div>
                <div class="p-4">
                  <div class="flex items-start gap-4">
                    <span class="shrink-0 w-8 h-8 bg-brand rounded-lg flex items-center justify-center text-white font-bold text-sm">5</span>
                    <div>
                      <h4 class="font-medium mb-1">Mnemonic Verification</h4>
                      <p class="text-text-secondary text-sm">Both devices display 6-word checksum. Users verbally confirm match to detect tampering.</p>
                    </div>
                  </div>
                </div>
                <div class="p-4">
                  <div class="flex items-start gap-4">
                    <span class="shrink-0 w-8 h-8 bg-success rounded-lg flex items-center justify-center text-white font-bold text-sm">6</span>
                    <div>
                      <h4 class="font-medium mb-1">Activation</h4>
                      <p class="text-text-secondary text-sm">Tokens derived from pad. Conversation becomes active. Messaging available.</p>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div id="passphrase" class="mb-8">
            <h3 class="text-xl font-semibold mb-4">3.2 Passphrase Protection</h3>
            <p class="text-text-secondary mb-4">
              Every ceremony requires a <strong class="text-white">mandatory passphrase</strong> that encrypts QR frames during transfer. This protects against visual observation attacks.
            </p>

            <div class="bg-bg-card border border-border rounded-lg overflow-hidden mb-4">
              <table class="w-full text-sm">
                <thead>
                  <tr class="border-b border-border bg-bg-elevated">
                    <th class="text-left p-3 text-text-muted font-medium">Property</th>
                    <th class="text-left p-3 text-text-muted font-medium">Requirement</th>
                  </tr>
                </thead>
                <tbody class="divide-y divide-border">
                  <tr><td class="p-3">Minimum length</td><td class="p-3 text-text-secondary">4 characters</td></tr>
                  <tr><td class="p-3">Exchange method</td><td class="p-3 text-text-secondary">Verbal (spoken between parties)</td></tr>
                  <tr><td class="p-3">Key derivation</td><td class="p-3 text-text-secondary">SHA-256 hash of passphrase</td></tr>
                  <tr><td class="p-3">Frame encryption</td><td class="p-3 text-text-secondary">XOR with derived key stream</td></tr>
                </tbody>
              </table>
            </div>

            <InfoBox>
              <p class="text-sm">
                <strong class="text-white">Defense in depth:</strong> The passphrase adds a second layer of protection. Even if QR codes are visually captured, the attacker cannot reconstruct the pad without the passphrase. Both parties must enter the same passphrase for the ceremony to succeed.
              </p>
            </InfoBox>
          </div>

          <div id="mnemonic" class="mb-8">
            <h3 class="text-xl font-semibold mb-4">3.3 Mnemonic Verification</h3>
            <p class="text-text-secondary mb-4">
              The mnemonic checksum allows human verification that both devices have identical pads.
            </p>

            <div class="bg-bg-card border border-border rounded-lg overflow-hidden">
              <table class="w-full text-sm">
                <thead>
                  <tr class="border-b border-border bg-bg-elevated">
                    <th class="text-left p-3 text-text-muted font-medium">Property</th>
                    <th class="text-left p-3 text-text-muted font-medium">Value</th>
                  </tr>
                </thead>
                <tbody class="divide-y divide-border">
                  <tr><td class="p-3">Wordlist size</td><td class="p-3 text-text-secondary">512 words (custom, not BIP-39)</td></tr>
                  <tr><td class="p-3">Bits per word</td><td class="p-3 text-text-secondary">9 bits (512 = 2^9)</td></tr>
                  <tr><td class="p-3">Word count</td><td class="p-3 text-text-secondary">6 words</td></tr>
                  <tr><td class="p-3">Verification entropy</td><td class="p-3 text-text-secondary">54 bits</td></tr>
                  <tr><td class="p-3">Word format</td><td class="p-3 text-text-secondary">3-7 characters, lowercase ASCII</td></tr>
                </tbody>
              </table>
            </div>

            <p class="text-text-secondary mt-4 text-sm">
              Words are optimized for verbal clarity: distinct pronunciation, no homophones, minimal confusion between similar words, and cross-language usability.
            </p>

            <div class="demo-section mt-6">
              <h4 class="font-medium mb-3">Try It Yourself</h4>
              <p class="text-text-secondary text-sm mb-4">
                Generate mnemonic checksums from random pad bytes. Both devices generate identical words from the same pad.
              </p>
              <MnemonicDemo client:load />
            </div>
          </div>

          <div id="pad-sizes" class="mb-8">
            <h3 class="text-xl font-semibold mb-4">3.4 Pad Size Options</h3>

            <p class="text-text-secondary mb-4">
              ASH supports both preset sizes and <strong class="text-white">custom pad sizes</strong> from 32 KB to 10 MB. Larger pads support more messages but require longer ceremony transfer times.
            </p>

            <div class="bg-bg-card border border-border rounded-lg overflow-x-auto mb-4">
              <table class="w-full text-sm">
                <thead>
                  <tr class="border-b border-border bg-bg-elevated">
                    <th class="text-left p-3 text-text-muted font-medium">Size</th>
                    <th class="text-left p-3 text-text-muted font-medium">Bytes</th>
                    <th class="text-left p-3 text-text-muted font-medium">Capacity*</th>
                    <th class="text-left p-3 text-text-muted font-medium">Frames</th>
                  </tr>
                </thead>
                <tbody class="divide-y divide-border">
                  <tr><td class="p-3">Small (64 KB)</td><td class="p-3 text-text-secondary">65,536</td><td class="p-3 text-text-secondary">~680 messages</td><td class="p-3 text-text-secondary">~44</td></tr>
                  <tr><td class="p-3">Medium (256 KB)</td><td class="p-3 text-text-secondary">262,144</td><td class="p-3 text-text-secondary">~2,700 messages</td><td class="p-3 text-text-secondary">~175</td></tr>
                  <tr><td class="p-3">Large (512 KB)</td><td class="p-3 text-text-secondary">524,288</td><td class="p-3 text-text-secondary">~5,400 messages</td><td class="p-3 text-text-secondary">~350</td></tr>
                  <tr><td class="p-3">Huge (1 MB)</td><td class="p-3 text-text-secondary">1,048,576</td><td class="p-3 text-text-secondary">~10,900 messages</td><td class="p-3 text-text-secondary">~700</td></tr>
                  <tr><td class="p-3">Custom</td><td class="p-3 text-text-secondary">32 KB – 10 MB</td><td class="p-3 text-text-secondary">User-specified</td><td class="p-3 text-text-secondary">Variable</td></tr>
                </tbody>
              </table>
            </div>

            <p class="text-text-muted text-xs mb-4">
              * Message capacity = (pad_bytes - 160) / 96. Each message consumes minimum 96 bytes from the pad.
            </p>

            <!-- Pad Consumption Breakdown -->
            <div class="bg-bg-card border border-border rounded-lg overflow-hidden">
              <div class="px-4 py-2 border-b border-border bg-bg-elevated">
                <span class="text-xs font-medium text-text-secondary">Pad Consumption Breakdown</span>
              </div>
              <div class="p-4 space-y-3">
                <div class="text-sm">
                  <span class="text-text-muted">Reserved (once):</span>
                  <span class="text-text-secondary ml-2">160 bytes for tokens (conversation ID + auth + burn)</span>
                </div>
                <div class="text-sm">
                  <span class="text-text-muted">Per message:</span>
                </div>
                <div class="ml-4 space-y-2">
                  <div class="flex items-center gap-3 text-sm">
                    <span class="px-2 py-1 bg-brand/20 text-brand-light rounded font-mono text-xs">64 B</span>
                    <span class="text-text-secondary">Wegman-Carter auth key (r₁ + r₂ + s₁ + s₂)</span>
                  </div>
                  <div class="flex items-center gap-3 text-sm">
                    <span class="px-2 py-1 bg-success/20 text-success rounded font-mono text-xs">≥32 B</span>
                    <span class="text-text-secondary">OTP encryption key (= padded message length)</span>
                  </div>
                  <div class="flex items-center gap-3 text-sm border-t border-border pt-2 mt-2">
                    <span class="px-2 py-1 bg-warning/20 text-warning rounded font-mono text-xs font-semibold">≥96 B</span>
                    <span class="text-white font-medium">Minimum total per message</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </section>

        <!-- Section 4: Frame Format -->
        <section id="framing">
          <h2 class="text-2xl font-bold mb-6 pb-2 border-b border-border">4. Frame Format Specification</h2>

          <p class="text-text-secondary mb-6">
            Frames partition pad data into scannable QR codes, provide per-chunk integrity verification via CRC-32, and enable ordered reconstruction at the receiver.
          </p>

          <div id="basic-frame" class="mb-8">
            <h3 class="text-xl font-semibold mb-4">4.1 Basic Frame Structure</h3>

            <Diagram title="Frame Layout">
{`+------------------+------------------+------------------+------------------+
|   Frame Index    |   Total Frames   |   Payload        |   CRC-32         |
|   (2 bytes BE)   |   (2 bytes BE)   |   (N bytes)      |   (4 bytes BE)   |
+------------------+------------------+------------------+------------------+`}
            </Diagram>

            <div class="bg-bg-card border border-border rounded-lg overflow-hidden mt-4">
              <table class="w-full text-sm">
                <thead>
                  <tr class="border-b border-border bg-bg-elevated">
                    <th class="text-left p-3 text-text-muted font-medium">Field</th>
                    <th class="text-left p-3 text-text-muted font-medium">Size</th>
                    <th class="text-left p-3 text-text-muted font-medium">Description</th>
                  </tr>
                </thead>
                <tbody class="divide-y divide-border">
                  <tr><td class="p-3 font-mono text-xs">Frame Index</td><td class="p-3 text-text-secondary">2 bytes</td><td class="p-3 text-text-secondary">Zero-based index (big-endian)</td></tr>
                  <tr><td class="p-3 font-mono text-xs">Total Frames</td><td class="p-3 text-text-secondary">2 bytes</td><td class="p-3 text-text-secondary">Total frames in sequence (big-endian)</td></tr>
                  <tr><td class="p-3 font-mono text-xs">Payload</td><td class="p-3 text-text-secondary">Variable</td><td class="p-3 text-text-secondary">Pad bytes (max 1000 bytes)</td></tr>
                  <tr><td class="p-3 font-mono text-xs">CRC-32</td><td class="p-3 text-text-secondary">4 bytes</td><td class="p-3 text-text-secondary">CRC of preceding bytes (ISO 3309)</td></tr>
                </tbody>
              </table>
            </div>
          </div>

          <div id="extended-frame" class="mb-8">
            <h3 class="text-xl font-semibold mb-4">4.2 Extended Frame Format</h3>

            <p class="text-text-secondary mb-4">
              For ceremony transfer, an extended format includes metadata and optional encryption.
            </p>

            <Diagram title="Extended Frame">
{`+-------+-------+------------------+------------------+------------------+------------------+
| Magic | Flags | Frame Index      | Total Frames     | Payload          | CRC-32           |
| (1B)  | (1B)  | (2 bytes BE)     | (2 bytes BE)     | (max 1500B)      | (4 bytes BE)     |
+-------+-------+------------------+------------------+------------------+------------------+

Magic: 0xA5 (identifies extended format)
Flags: Bit 0 = ENCRYPTED, Bit 1 = METADATA`}
            </Diagram>

            <h4 class="font-medium mt-6 mb-3">Ceremony Metadata (Frame 0)</h4>
            <p class="text-text-secondary mb-4 text-sm">
              When METADATA flag is set, frame 0 contains ceremony settings:
            </p>

            <div class="bg-bg-card border border-border rounded-lg p-4 font-mono text-xs text-text-secondary">
              [version: u8][ttl: u64 BE][disappearing: u32 BE][url_len: u16 BE][url: bytes]
            </div>
          </div>
        </section>

        <!-- Section 5: Messaging Protocol -->
        <section id="messages">
          <h2 class="text-2xl font-bold mb-6 pb-2 border-b border-border">5. Messaging Protocol</h2>

          <p class="text-text-secondary mb-6">
            ASH messages combine <strong class="text-white">OTP encryption</strong>, <strong class="text-white">Wegman-Carter authentication</strong>, and <strong class="text-white">mandatory padding</strong> into a single authenticated frame. Every message provides both information-theoretic confidentiality and information-theoretic authentication.
          </p>

          <div id="message-frame" class="mb-8">
            <h3 class="text-xl font-semibold mb-4">5.1 Authenticated Message Frame</h3>

            <p class="text-text-secondary mb-4">
              All messages use this single frame format. The relay receives and stores these frames as opaque blobs.
            </p>

            <Diagram title="Message Frame Structure">
{`┌──────────┬──────────┬──────────┬──────────────────┬──────────────────┐
│ Version  │   Type   │  Length  │   Ciphertext     │   Auth Tag       │
│  (1 B)   │  (1 B)   │ (2 B BE) │   (N bytes)      │   (32 bytes)     │
└──────────┴──────────┴──────────┴──────────────────┴──────────────────┘
     │          │          │              │                   │
     │          │          │              │                   └─ Wegman-Carter 256-bit MAC
     │          │          │              └─ OTP-encrypted padded plaintext
     │          │          └─ Ciphertext length (big-endian)
     │          └─ Message type: 0x00=text, 0x01=location
     └─ Protocol version (currently 1)

Minimum frame size: 4 (header) + 32 (min ciphertext) + 32 (tag) = 68 bytes`}
            </Diagram>

            <div class="bg-bg-card border border-border rounded-lg overflow-hidden mt-4">
              <table class="w-full text-sm">
                <thead>
                  <tr class="border-b border-border bg-bg-elevated">
                    <th class="text-left p-3 text-text-muted font-medium">Field</th>
                    <th class="text-left p-3 text-text-muted font-medium">Size</th>
                    <th class="text-left p-3 text-text-muted font-medium">Description</th>
                  </tr>
                </thead>
                <tbody class="divide-y divide-border">
                  <tr><td class="p-3 font-mono text-xs">version</td><td class="p-3 text-text-secondary">1 byte</td><td class="p-3 text-text-secondary">Protocol version (1)</td></tr>
                  <tr><td class="p-3 font-mono text-xs">type</td><td class="p-3 text-text-secondary">1 byte</td><td class="p-3 text-text-secondary">0x00 = text, 0x01 = location</td></tr>
                  <tr><td class="p-3 font-mono text-xs">length</td><td class="p-3 text-text-secondary">2 bytes</td><td class="p-3 text-text-secondary">Ciphertext length (big-endian)</td></tr>
                  <tr><td class="p-3 font-mono text-xs">ciphertext</td><td class="p-3 text-text-secondary">≥32 bytes</td><td class="p-3 text-text-secondary">OTP-encrypted padded plaintext</td></tr>
                  <tr><td class="p-3 font-mono text-xs">auth_tag</td><td class="p-3 text-text-secondary">32 bytes</td><td class="p-3 text-text-secondary">Wegman-Carter 256-bit authentication tag</td></tr>
                </tbody>
              </table>
            </div>

            <h4 class="font-medium mt-6 mb-3">Pad Consumption Per Message</h4>
            <div class="bg-bg-card border border-border rounded-lg overflow-hidden">
              <table class="w-full text-sm">
                <thead>
                  <tr class="border-b border-border bg-bg-elevated">
                    <th class="text-left p-3 text-text-muted font-medium">Component</th>
                    <th class="text-left p-3 text-text-muted font-medium">Size</th>
                    <th class="text-left p-3 text-text-muted font-medium">Purpose</th>
                  </tr>
                </thead>
                <tbody class="divide-y divide-border">
                  <tr><td class="p-3">Auth key (r₁, r₂, s₁, s₂)</td><td class="p-3 text-text-secondary">64 bytes</td><td class="p-3 text-text-secondary">Wegman-Carter MAC computation</td></tr>
                  <tr><td class="p-3">Encryption key</td><td class="p-3 text-text-secondary">≥32 bytes</td><td class="p-3 text-text-secondary">OTP encryption (= padded plaintext length)</td></tr>
                  <tr><td class="p-3 font-semibold">Total minimum</td><td class="p-3 text-text-secondary font-semibold">96 bytes</td><td class="p-3 text-text-secondary">Per message (64 + 32)</td></tr>
                </tbody>
              </table>
            </div>
          </div>

          <div id="encryption-flow" class="mb-8">
            <h3 class="text-xl font-semibold mb-4">5.2 Message Processing Pipeline</h3>

            <p class="text-text-secondary mb-4">
              Every message passes through a symmetric pipeline that provides both confidentiality and authentication. The sender encrypts and authenticates; the receiver verifies and decrypts using the same shared pad.
            </p>

            <!-- Pipeline Summary -->
            <div class="grid sm:grid-cols-2 gap-4 mb-6">
              <div class="bg-bg-card border border-border rounded-lg p-4">
                <div class="flex items-center gap-2 mb-2">
                  <svg class="w-5 h-5 text-brand" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M7 11l5-5m0 0l5 5m-5-5v12" />
                  </svg>
                  <span class="font-semibold text-white">Sender</span>
                </div>
                <ol class="text-sm text-text-secondary space-y-1 ml-7 list-decimal">
                  <li><strong class="text-white">Pad</strong> message to minimum 32 bytes</li>
                  <li><strong class="text-white">Encrypt</strong> with OTP (XOR with pad bytes)</li>
                  <li><strong class="text-white">Authenticate</strong> with Wegman-Carter MAC</li>
                  <li>Assemble frame and send to relay</li>
                </ol>
              </div>
              <div class="bg-bg-card border border-border rounded-lg p-4">
                <div class="flex items-center gap-2 mb-2">
                  <svg class="w-5 h-5 text-success" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M17 13l-5 5m0 0l-5-5m5 5V6" />
                  </svg>
                  <span class="font-semibold text-white">Receiver</span>
                </div>
                <ol class="text-sm text-text-secondary space-y-1 ml-7 list-decimal">
                  <li><strong class="text-white">Verify</strong> MAC (reject if tampered)</li>
                  <li><strong class="text-white">Decrypt</strong> with OTP (XOR is symmetric)</li>
                  <li><strong class="text-white">Unpad</strong> to extract original message</li>
                  <li>Display message, zero used pad bytes</li>
                </ol>
              </div>
            </div>

            <div class="demo-section">
              <p class="text-text-secondary text-sm mb-4">
                The interactive demo below shows this pipeline in action using the actual Rust cryptographic core compiled to WebAssembly — the same code that runs on devices.
              </p>
              <MessagePipelineDemo client:load />
            </div>

            <div id="authentication"></div>
            <h3 class="text-xl font-semibold mt-8 mb-4">5.3 Wegman-Carter Authentication</h3>

            <p class="text-text-secondary mb-4">
              The authentication tag is computed using dual polynomial evaluation over the Galois Field GF(2^128). This provides <strong class="text-white">information-theoretic authentication</strong> — mathematically proven unforgeable without the pad.
            </p>

            <!-- How It Works -->
            <div class="bg-bg-card border border-border rounded-xl overflow-hidden mb-6">
              <div class="px-4 py-3 border-b border-border bg-bg-elevated">
                <h5 class="font-semibold text-white">How Wegman-Carter Works</h5>
              </div>
              <div class="p-5 space-y-4">
                <p class="text-text-secondary text-sm">
                  The core idea: treat the message as coefficients of a polynomial, evaluate it at a secret random point <code class="text-brand">r</code>, then mask the result with a one-time pad value <code class="text-success">s</code>.
                </p>

                <!-- Conceptual Flow -->
                <div class="flex flex-col sm:flex-row items-center gap-3 text-sm">
                  <div class="px-4 py-2 bg-bg-elevated rounded-lg border border-border text-center">
                    <div class="text-text-muted text-xs mb-1">Message</div>
                    <div class="font-mono text-white">M = [b₁, b₂, ..., bₙ]</div>
                  </div>
                  <svg class="w-5 h-5 text-text-muted rotate-90 sm:rotate-0 shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3" /></svg>
                  <div class="px-4 py-2 bg-brand/10 rounded-lg border border-brand/30 text-center">
                    <div class="text-text-muted text-xs mb-1">Polynomial</div>
                    <div class="font-mono text-brand-light">P(x) = b₁x^n + b₂x^(n-1) + ...</div>
                  </div>
                  <svg class="w-5 h-5 text-text-muted rotate-90 sm:rotate-0 shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3" /></svg>
                  <div class="px-4 py-2 bg-success/10 rounded-lg border border-success/30 text-center">
                    <div class="text-text-muted text-xs mb-1">Tag</div>
                    <div class="font-mono text-success">P(r) ⊕ s</div>
                  </div>
                </div>

                <!-- Algorithm Steps -->
                <div class="mt-4 space-y-3">
                  <div class="flex items-start gap-3">
                    <span class="shrink-0 w-6 h-6 bg-brand/20 rounded flex items-center justify-center text-brand text-xs font-bold">1</span>
                    <div class="text-sm">
                      <span class="text-white font-medium">Split message into 128-bit blocks:</span>
                      <span class="text-text-secondary"> Each 16-byte chunk becomes a field element.</span>
                    </div>
                  </div>
                  <div class="flex items-start gap-3">
                    <span class="shrink-0 w-6 h-6 bg-brand/20 rounded flex items-center justify-center text-brand text-xs font-bold">2</span>
                    <div class="text-sm">
                      <span class="text-white font-medium">Build polynomial:</span>
                      <span class="text-text-secondary"> Blocks are coefficients: P(x) = b₁·x^n + b₂·x^(n-1) + ... + bₙ·x</span>
                    </div>
                  </div>
                  <div class="flex items-start gap-3">
                    <span class="shrink-0 w-6 h-6 bg-brand/20 rounded flex items-center justify-center text-brand text-xs font-bold">3</span>
                    <div class="text-sm">
                      <span class="text-white font-medium">Evaluate at secret point r:</span>
                      <span class="text-text-secondary"> Compute P(r) in GF(2^128) using Horner's method.</span>
                    </div>
                  </div>
                  <div class="flex items-start gap-3">
                    <span class="shrink-0 w-6 h-6 bg-success/20 rounded flex items-center justify-center text-success text-xs font-bold">4</span>
                    <div class="text-sm">
                      <span class="text-white font-medium">Apply OTP mask:</span>
                      <span class="text-text-secondary"> Tag = P(r) ⊕ s. The mask s is never reused.</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Worked Example -->
            <div class="bg-bg-card border border-border rounded-xl overflow-hidden mb-6">
              <div class="px-4 py-3 border-b border-border bg-bg-elevated">
                <h5 class="font-semibold text-white">Worked Example</h5>
              </div>
              <div class="p-5 space-y-4">
                <p class="text-text-secondary text-sm">
                  Authenticating a 32-byte ciphertext (2 blocks):
                </p>

                <!-- Input -->
                <div class="bg-bg-elevated rounded-lg p-4 space-y-3">
                  <div class="flex flex-wrap items-center gap-2 text-sm">
                    <span class="text-text-muted w-20">Ciphertext:</span>
                    <code class="text-warning font-mono text-xs">A3F1...29F6</code>
                    <span class="text-text-muted">(block 1, 16 bytes)</span>
                    <code class="text-warning font-mono text-xs">6EC4...D8B2</code>
                    <span class="text-text-muted">(block 2, 16 bytes)</span>
                  </div>
                  <div class="flex flex-wrap items-center gap-2 text-sm">
                    <span class="text-text-muted w-20">Auth key:</span>
                    <code class="text-brand font-mono text-xs">r = 7B3A...F912</code>
                    <span class="text-text-muted">(random point)</span>
                    <code class="text-success font-mono text-xs">s = E5C1...8D4A</code>
                    <span class="text-text-muted">(OTP mask)</span>
                  </div>
                </div>

                <!-- Computation -->
                <div class="space-y-2 text-sm">
                  <div class="flex items-center gap-2">
                    <span class="text-text-muted">Step 1:</span>
                    <span class="text-text-secondary">Polynomial P(x) = b₁·x² + b₂·x</span>
                  </div>
                  <div class="flex items-center gap-2">
                    <span class="text-text-muted">Step 2:</span>
                    <span class="text-text-secondary">Horner's method: ((b₁ · r) + b₂) · r</span>
                  </div>
                  <div class="flex items-center gap-2">
                    <span class="text-text-muted">Step 3:</span>
                    <span class="text-text-secondary">P(r) = <code class="text-brand-light font-mono">3D7F...A2E1</code> (GF multiplication)</span>
                  </div>
                  <div class="flex items-center gap-2">
                    <span class="text-text-muted">Step 4:</span>
                    <span class="text-text-secondary">Tag = P(r) ⊕ s = <code class="text-success font-mono">D8BE...2FAB</code></span>
                  </div>
                </div>

                <!-- Final Tag -->
                <div class="bg-success/10 border border-success/30 rounded-lg p-3">
                  <div class="flex items-center gap-2 text-sm">
                    <svg class="w-4 h-4 text-success shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg>
                    <span class="text-success font-medium">128-bit tag:</span>
                    <code class="text-success font-mono text-xs">D8BE...2FAB</code>
                  </div>
                  <p class="text-text-muted text-xs mt-2">ASH uses dual evaluation (r₁, r₂ with s₁, s₂) to produce a 256-bit tag.</p>
                </div>
              </div>
            </div>

            <!-- Live Demo -->
            <div class="demo-section mb-6">
              <h5 class="font-semibold text-white mb-3">Try It Yourself</h5>
              <p class="text-text-secondary text-sm mb-4">
                This interactive demo uses the actual ASH Rust cryptographic core compiled to WebAssembly.
                Type a message, see how the polynomial is constructed, and verify the authentication tag.
              </p>
              <PolyHashDemo client:load />
            </div>

            <!-- Why It's Secure -->
            <div class="bg-bg-card border border-border rounded-xl overflow-hidden mb-6">
              <div class="px-4 py-3 border-b border-border bg-bg-elevated">
                <h5 class="font-semibold text-white">Why It's Unforgeable</h5>
              </div>
              <div class="p-5 space-y-3 text-sm text-text-secondary">
                <p>
                  <strong class="text-white">Without knowing r:</strong> An attacker sees only P(r) ⊕ s. The OTP mask s hides P(r) completely. They cannot learn r from a single tag.
                </p>
                <p>
                  <strong class="text-white">To forge a different message M':</strong> They need P'(r) ⊕ s = P(r) ⊕ s ⊕ (P(r) ⊕ P'(r)). But P(r) ⊕ P'(r) is unknown without r.
                </p>
                <p>
                  <strong class="text-white">Probability of guessing:</strong> For a degree-n polynomial in GF(2^128), there are at most n values where P(r) = P'(r). Probability of collision: n/2^128 ≈ 0.
                </p>
              </div>
            </div>

            <!-- Properties Table -->
            <div class="bg-bg-card border border-border rounded-lg overflow-hidden">
              <table class="w-full text-sm">
                <thead>
                  <tr class="border-b border-border bg-bg-elevated">
                    <th class="text-left p-3 text-text-muted font-medium">Property</th>
                    <th class="text-left p-3 text-text-muted font-medium">Value</th>
                  </tr>
                </thead>
                <tbody class="divide-y divide-border">
                  <tr><td class="p-3">Tag size</td><td class="p-3 text-text-secondary">256 bits (32 bytes)</td></tr>
                  <tr><td class="p-3">Auth key</td><td class="p-3 text-text-secondary">64 bytes: r₁ (16) + r₂ (16) + s₁ (16) + s₂ (16)</td></tr>
                  <tr><td class="p-3">Field polynomial</td><td class="p-3 text-text-secondary font-mono text-xs">x^128 + x^7 + x^2 + x + 1</td></tr>
                  <tr><td class="p-3">Forgery probability</td><td class="p-3 text-text-secondary">~2^-128 (negligible)</td></tr>
                  <tr><td class="p-3">Security level</td><td class="p-3 text-text-secondary">Information-theoretic (unconditional)</td></tr>
                </tbody>
              </table>
            </div>

            <InfoBox class="mt-4">
              <p class="text-sm">
                <strong class="text-white">Why dual polynomials?</strong> Using two independent evaluations (r₁, r₂) with separate OTP masks (s₁, s₂) provides 256-bit security. A single polynomial would only give ~2^-64 forgery resistance.
              </p>
            </InfoBox>

            <h4 class="font-medium mt-6 mb-3">Traffic Analysis Protection</h4>

            <p class="text-text-secondary mb-4">
              All messages are padded to <strong class="text-white">minimum 32 bytes</strong> before encryption. Without this, short messages would be distinguishable by size.
            </p>

            <Diagram title="Padding Effect">
{`Without padding (vulnerable to traffic analysis):
  "yes"           → 3 bytes   ┐
  "no"            → 2 bytes   ├─ Distinguishable!
  "I'll be there" → 13 bytes  ┘

With mandatory 32-byte padding:
  "yes"           → 32 bytes  ┐
  "no"            → 32 bytes  ├─ All identical size
  "I'll be there" → 32 bytes  ┘

Padding format: [0x00 marker][2-byte length][content][zero fill to 32]`}
            </Diagram>

            <div class="demo-section mt-6">
              <h5 class="font-medium mb-3">Try It Yourself</h5>
              <p class="text-text-secondary text-sm mb-4">
                See exactly how messages are padded. Type any message and observe the padding format.
              </p>
              <PaddingDemo client:load />
            </div>

            <InfoBox variant="warning" class="mt-4">
              <p class="text-sm">
                <strong>Attack prevented:</strong> Without padding, an adversary observing encrypted message sizes could fingerprint "yes/no" responses, detect typing patterns, or infer conversation topics from message length sequences.
              </p>
            </InfoBox>
          </div>

          <div id="bidirectional" class="mb-8">
            <h3 class="text-xl font-semibold mb-4">5.4 Bidirectional Pad Consumption</h3>

            <p class="text-text-secondary mb-4">
              ASH uses a bidirectional consumption model to enable independent messaging by both parties without coordination or collision.
            </p>

            <Diagram title="Pad Consumption Model">
{`Pad:  [████████████████████████████████████████████████████████████████]
       ↑                                                              ↑
       │                                                              │
       Initiator (Alice)                                  Responder (Bob)
       consumes →                                              ← consumes

Example (100-byte pad):
Start:  [░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░]
        0                                                           99

Alice sends 20 bytes:
        [████████████████████░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░]
        0                  19                                       99

Bob sends 30 bytes:
        [████████████████████░░░░░░░░░░░░░░░░░░░░░░██████████████████]
        0                  19                    69                 99

Remaining: 50 bytes (indices 20-69)`}
            </Diagram>

            <div class="bg-bg-card border border-border rounded-lg overflow-hidden mt-4">
              <div class="px-4 py-2 border-b border-border bg-bg-elevated">
                <span class="text-xs font-medium text-text-secondary">Consumption Rules</span>
              </div>
              <ul class="p-4 space-y-2 text-sm text-text-secondary">
                <li>• <strong class="text-white">Initiator (ceremony starter):</strong> Consumes bytes from index 0 forward</li>
                <li>• <strong class="text-white">Responder (ceremony receiver):</strong> Consumes bytes from the end backward</li>
                <li>• <strong class="text-white">No overlap:</strong> The two fronts never collide (pad exhausted when they meet)</li>
                <li>• <strong class="text-white">Independent:</strong> Either party can send without waiting for the other</li>
                <li>• <strong class="text-white">Asymmetric:</strong> Alice can use 20%, Bob can use 80% (or any split)</li>
              </ul>
            </div>

            <h4 class="font-medium mt-6 mb-3">Forward Secrecy</h4>
            <p class="text-text-secondary text-sm">
              After encryption, the used pad bytes are securely zeroed. Even if an attacker later compromises the device, they cannot decrypt messages encrypted with already-destroyed key material.
            </p>
          </div>

          <div id="message-types" class="mb-8">
            <h3 class="text-xl font-semibold mb-4">5.5 Message Types</h3>

            <p class="text-text-secondary mb-4">
              ASH v1 supports two message types. Both are encrypted identically — the type is determined by content structure after decryption.
            </p>

            <div class="bg-bg-card border border-border rounded-lg overflow-hidden">
              <table class="w-full text-sm">
                <thead>
                  <tr class="border-b border-border bg-bg-elevated">
                    <th class="text-left p-3 text-text-muted font-medium">Type</th>
                    <th class="text-left p-3 text-text-muted font-medium">Format</th>
                    <th class="text-left p-3 text-text-muted font-medium">Size</th>
                  </tr>
                </thead>
                <tbody class="divide-y divide-border">
                  <tr>
                    <td class="p-3 font-medium">Text</td>
                    <td class="p-3 text-text-secondary">UTF-8 string</td>
                    <td class="p-3 text-text-secondary">1 byte per character (ASCII) or more (Unicode)</td>
                  </tr>
                  <tr>
                    <td class="p-3 font-medium">Location</td>
                    <td class="p-3 text-text-secondary font-mono text-xs">lat,lng (6 decimal places)</td>
                    <td class="p-3 text-text-secondary">~25 bytes (e.g., "37.774929,-122.419418")</td>
                  </tr>
                </tbody>
              </table>
            </div>

            <InfoBox variant="warning" class="mt-4">
              <p class="text-sm">
                <strong>No media support:</strong> Photos and videos would exhaust pad capacity quickly. ASH intentionally supports only text and one-shot location sharing. This is a security feature, not a limitation.
              </p>
            </InfoBox>

            <h4 class="font-medium mt-6 mb-3">Message Lifecycle</h4>
            <Diagram title="Message Flow">
{`Sender                      Relay (RAM)                     Receiver
  │                              │                              │
  │  1. Pad message to 32 bytes  │                              │
  │  2. Consume 64+N pad bytes   │                              │
  │  3. OTP encrypt              │                              │
  │  4. Compute Wegman-Carter tag│                              │
  │  5. Assemble frame           │                              │
  │                              │                              │
  │  POST /v1/messages ──────────►  (store frame, start TTL)    │
  │  ◄── {blob_id} ──────────────│                              │
  │                              │                              │
  │                              │  SSE: new message ───────────►
  │                              │                 1. Verify tag │
  │                              │                 2. Decrypt    │
  │                              │                 3. Unpad      │
  │                              │  ◄── POST /v1/ack ───────────│
  │  ◄── SSE: delivered ─────────│  (delete from RAM)           │
  │                              │                              │
  │  6. Zero used pad bytes      │                              │`}
            </Diagram>
          </div>
        </section>

        <!-- Section 6: Token Derivation -->
        <section id="tokens">
          <h2 class="text-2xl font-bold mb-6 pb-2 border-b border-border">6. Authorization Token Derivation</h2>

          <p class="text-text-secondary mb-6">
            Authorization tokens enable API authentication without accounts or identity. Both parties derive the same tokens from the shared pad.
          </p>

          <div class="bg-bg-card border border-border rounded-lg overflow-hidden">
            <table class="w-full text-sm">
              <thead>
                <tr class="border-b border-border bg-bg-elevated">
                  <th class="text-left p-3 text-text-muted font-medium">Token</th>
                  <th class="text-left p-3 text-text-muted font-medium">Pad Bytes</th>
                  <th class="text-left p-3 text-text-muted font-medium">Purpose</th>
                </tr>
              </thead>
              <tbody class="divide-y divide-border">
                <tr><td class="p-3 font-medium">Conversation ID</td><td class="p-3 text-text-secondary font-mono text-xs">0-31</td><td class="p-3 text-text-secondary">Identifies the conversation on the relay</td></tr>
                <tr><td class="p-3 font-medium">Auth Token</td><td class="p-3 text-text-secondary font-mono text-xs">32-95</td><td class="p-3 text-text-secondary">Authenticates API requests</td></tr>
                <tr><td class="p-3 font-medium">Burn Token</td><td class="p-3 text-text-secondary font-mono text-xs">96-159</td><td class="p-3 text-text-secondary">Required for burn operations</td></tr>
              </tbody>
            </table>
          </div>

          <h3 class="text-lg font-semibold mt-6 mb-3">Derivation Process</h3>
          <ol class="list-decimal list-inside text-text-secondary space-y-1 text-sm">
            <li>Extract specific byte ranges from pad</li>
            <li>XOR-fold to 32-byte output</li>
            <li>Apply domain separation constant</li>
            <li>Multiple mixing rounds for diffusion</li>
            <li>Encode as 64-character lowercase hex</li>
          </ol>

          <h3 class="text-lg font-semibold mt-6 mb-3">Security Properties</h3>
          <ul class="list-disc list-inside text-text-secondary space-y-1 text-sm">
            <li><strong class="text-white">Deterministic:</strong> Same pad produces same tokens on both devices</li>
            <li><strong class="text-white">Unpredictable:</strong> Without pad, tokens cannot be computed or forged</li>
            <li><strong class="text-white">Separated:</strong> Different tokens for different operations</li>
            <li><strong class="text-white">Backend-safe:</strong> Backend stores only hash(token)</li>
          </ul>

          <div class="demo-section mt-6">
            <h3 class="text-lg font-semibold mb-3">Try It Yourself</h3>
            <p class="text-text-secondary text-sm mb-4">
              Watch how tokens are derived from specific byte ranges of the pad. Hover over each token to highlight its source bytes.
            </p>
            <TokenDemo client:load />
          </div>
        </section>

        <!-- Section 7: Trust Model -->
        <section id="trust">
          <h2 class="text-2xl font-bold mb-6 pb-2 border-b border-border">7. Trust Model</h2>

          <p class="text-text-secondary mb-6">
            ASH explicitly defines what each component is trusted to do. This is fundamental to the security model.
          </p>

          <div class="bg-bg-card border border-border rounded-lg overflow-hidden">
            <table class="w-full text-sm">
              <thead>
                <tr class="border-b border-border bg-bg-elevated">
                  <th class="text-left p-3 text-text-muted font-medium">Component</th>
                  <th class="text-left p-3 text-text-muted font-medium">Trust Level</th>
                  <th class="text-left p-3 text-text-muted font-medium">Rationale</th>
                </tr>
              </thead>
              <tbody class="divide-y divide-border">
                <tr><td class="p-3 font-medium">ash-core</td><td class="p-3"><span class="px-2 py-0.5 bg-success/20 text-success rounded text-xs">Trusted</span></td><td class="p-3 text-text-secondary">Cryptographic authority, minimal surface</td></tr>
                <tr><td class="p-3 font-medium">iOS App</td><td class="p-3"><span class="px-2 py-0.5 bg-warning/20 text-warning rounded text-xs">Partially</span></td><td class="p-3 text-text-secondary">Handles UI, invokes core, stores keys</td></tr>
                <tr><td class="p-3 font-medium">Backend</td><td class="p-3"><span class="px-2 py-0.5 bg-danger/20 text-danger rounded text-xs">Untrusted</span></td><td class="p-3 text-text-secondary">Never sees plaintext or keys</td></tr>
                <tr><td class="p-3 font-medium">Network</td><td class="p-3"><span class="px-2 py-0.5 bg-danger/20 text-danger rounded text-xs">Untrusted</span></td><td class="p-3 text-text-secondary">All traffic is encrypted blobs</td></tr>
                <tr><td class="p-3 font-medium">User</td><td class="p-3"><span class="px-2 py-0.5 bg-success/20 text-success rounded text-xs">Trusted</span></td><td class="p-3 text-text-secondary">Must perform ceremony correctly</td></tr>
              </tbody>
            </table>
          </div>

          <InfoBox class="mt-6">
            <p class="text-sm">
              <strong class="text-white">Design consequence:</strong> ASH deliberately avoids background synchronization, convenience features, user accounts, key recovery, cloud storage, and analytics. All constraints are intentional.
            </p>
          </InfoBox>
        </section>

        <!-- Glossary -->
        <section id="glossary" class="pt-8 border-t border-border">
          <h2 class="text-2xl font-bold mb-6 pb-2 border-b border-border">Glossary</h2>

          <div class="bg-bg-card border border-border rounded-lg overflow-hidden">
            <dl class="divide-y divide-border">
              <div class="p-4 grid sm:grid-cols-[200px_1fr] gap-2">
                <dt class="font-medium text-white">Ceremony</dt>
                <dd class="text-text-secondary text-sm">The in-person key establishment process between two devices, resulting in a shared One-Time Pad.</dd>
              </div>
              <div class="p-4 grid sm:grid-cols-[200px_1fr] gap-2">
                <dt class="font-medium text-white">GF(2^128)</dt>
                <dd class="text-text-secondary text-sm">Galois Field with 2^128 elements. A finite field used for polynomial arithmetic in Wegman-Carter authentication.</dd>
              </div>
              <div class="p-4 grid sm:grid-cols-[200px_1fr] gap-2">
                <dt class="font-medium text-white">Information-theoretic security</dt>
                <dd class="text-text-secondary text-sm">Security guaranteed by mathematical proof, not computational assumptions. Holds against adversaries with unlimited computing power.</dd>
              </div>
              <div class="p-4 grid sm:grid-cols-[200px_1fr] gap-2">
                <dt class="font-medium text-white">Initiator</dt>
                <dd class="text-text-secondary text-sm">The party who starts the ceremony and generates the pad. Consumes pad bytes from index 0 forward.</dd>
              </div>
              <div class="p-4 grid sm:grid-cols-[200px_1fr] gap-2">
                <dt class="font-medium text-white">One-Time Pad (OTP)</dt>
                <dd class="text-text-secondary text-sm">Encryption method using XOR with a random key equal in length to the message, used exactly once.</dd>
              </div>
              <div class="p-4 grid sm:grid-cols-[200px_1fr] gap-2">
                <dt class="font-medium text-white">Pad</dt>
                <dd class="text-text-secondary text-sm">The shared random key material generated during ceremony. Consumed bidirectionally for encryption and authentication.</dd>
              </div>
              <div class="p-4 grid sm:grid-cols-[200px_1fr] gap-2">
                <dt class="font-medium text-white">Perfect secrecy</dt>
                <dd class="text-text-secondary text-sm">Shannon's definition: ciphertext reveals no information about plaintext. P(M|C) = P(M) for all messages M and ciphertexts C.</dd>
              </div>
              <div class="p-4 grid sm:grid-cols-[200px_1fr] gap-2">
                <dt class="font-medium text-white">Responder</dt>
                <dd class="text-text-secondary text-sm">The party who receives the pad during ceremony. Consumes pad bytes from the end backward.</dd>
              </div>
              <div class="p-4 grid sm:grid-cols-[200px_1fr] gap-2">
                <dt class="font-medium text-white">Wegman-Carter MAC</dt>
                <dd class="text-text-secondary text-sm">Message authentication code using polynomial evaluation over a finite field, providing information-theoretic authentication.</dd>
              </div>
            </dl>
          </div>
        </section>

        <!-- References -->
        <section id="sources" class="pt-8 border-t border-border">
          <h2 class="text-2xl font-bold mb-6 pb-2 border-b border-border">References</h2>

          <div class="space-y-6">
            <div>
              <h3 class="text-sm font-semibold text-white mb-3">Cryptographic Foundations</h3>
              <ul class="space-y-2 text-sm text-text-secondary">
                <li>
                  <a href="https://www.cs.virginia.edu/~evans/greatworks/shannon1949.pdf" target="_blank" rel="noopener noreferrer" class="text-brand hover:text-brand-light">Shannon, C.E. (1949)</a> — "Communication Theory of Secrecy Systems" — Mathematical proof of perfect secrecy for One-Time Pad encryption.
                </li>
                <li>
                  <a href="https://www.cs.umd.edu/~jkatz/gradcrypto2/NOTES/lecture4.pdf" target="_blank" rel="noopener noreferrer" class="text-brand hover:text-brand-light">Wegman, M.N. & Carter, J.L. (1981)</a> — "New Hash Functions and Their Use in Authentication and Set Equality" — Information-theoretic message authentication.
                </li>
                <li>
                  <a href="https://csrc.nist.gov/csrc/media/publications/fips/180/2/archive/2002-08-01/documents/fips180-2.pdf" target="_blank" rel="noopener noreferrer" class="text-brand hover:text-brand-light">FIPS 180-2</a> — SHA-256 specification used for passphrase key derivation.
                </li>
                <li>
                  <a href="https://www.w3.org/TR/PNG/#D-CRCAppendix" target="_blank" rel="noopener noreferrer" class="text-brand hover:text-brand-light">ISO 3309 / ITU-T V.42</a> — CRC-32 polynomial used for frame integrity verification.
                </li>
              </ul>
            </div>

            <div>
              <h3 class="text-sm font-semibold text-white mb-3">Galois Field Mathematics</h3>
              <ul class="space-y-2 text-sm text-text-secondary">
                <li>
                  <a href="https://nvlpubs.nist.gov/nistpubs/Legacy/SP/nistspecialpublication800-38d.pdf" target="_blank" rel="noopener noreferrer" class="text-brand hover:text-brand-light">NIST SP 800-38D</a> — GF(2^128) field operations and the irreducible polynomial x^128 + x^7 + x^2 + x + 1 used in GCM (same field as Wegman-Carter).
                </li>
                <li>
                  <a href="https://cr.yp.to/papers.html#poly1305" target="_blank" rel="noopener noreferrer" class="text-brand hover:text-brand-light">Bernstein, D.J. (2005)</a> — "The Poly1305-AES message-authentication code" — Related polynomial MAC construction.
                </li>
              </ul>
            </div>

            <div>
              <h3 class="text-sm font-semibold text-white mb-3">Security Analysis</h3>
              <ul class="space-y-2 text-sm text-text-secondary">
                <li>
                  <a href="https://eprint.iacr.org/2000/025.pdf" target="_blank" rel="noopener noreferrer" class="text-brand hover:text-brand-light">Rogaway, P. (2000)</a> — "Authenticated-Encryption with Associated-Data" — Formal definitions of authenticated encryption security.
                </li>
                <li>
                  <a href="https://www.usenix.org/system/files/sec19-liu-hao.pdf" target="_blank" rel="noopener noreferrer" class="text-brand hover:text-brand-light">Liu, H. et al. (2019)</a> — "Traffic Analysis of Encrypted Messaging" — Why message padding matters for privacy.
                </li>
              </ul>
            </div>
          </div>

        </section>

        <!-- Revision History -->
        <section id="changelog" class="pt-8 border-t border-border">
          <h2 class="text-2xl font-bold mb-6 pb-2 border-b border-border">Revision History</h2>

          <div class="bg-bg-card border border-border rounded-lg overflow-hidden">
            <table class="w-full text-sm">
              <thead>
                <tr class="border-b border-border bg-bg-elevated">
                  <th class="text-left p-3 text-text-muted font-medium">Version</th>
                  <th class="text-left p-3 text-text-muted font-medium">Date</th>
                  <th class="text-left p-3 text-text-muted font-medium">Author</th>
                  <th class="text-left p-3 text-text-muted font-medium">Changes</th>
                </tr>
              </thead>
              <tbody class="divide-y divide-border">
                <tr>
                  <td class="p-3 font-mono text-xs">1.0.0-draft</td>
                  <td class="p-3 text-text-secondary">2025-01-22</td>
                  <td class="p-3 text-text-secondary"><a href="https://github.com/tmihalicka" target="_blank" rel="noopener noreferrer" class="text-brand hover:text-brand-light">tmihalicka</a></td>
                  <td class="p-3 text-text-secondary">Initial draft for review</td>
                </tr>
              </tbody>
            </table>
          </div>

        </section>

        <!-- Feedback Section -->
        <section id="feedback" class="pt-8 border-t border-border">
          <h2 class="text-2xl font-bold mb-6 pb-2 border-b border-border">Feedback & Discussion</h2>

          <div class="bg-bg-card border border-border rounded-xl p-6">
            <p class="text-text-secondary mb-6">
              This whitepaper is a living document. We welcome feedback, questions, and suggestions from the community.
            </p>

            <div class="grid sm:grid-cols-2 gap-4">
              <a href="https://github.com/monadial/ash/issues/new?template=rfc.md&title=[RFC]%20Whitepaper%20Feedback:%20" target="_blank" rel="noopener noreferrer" class="bg-bg-elevated border border-border rounded-lg p-4 hover:border-brand/50 transition-colors group">
                <div class="flex items-center gap-3 mb-2">
                  <svg class="w-5 h-5 text-text-muted group-hover:text-brand transition-colors" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/>
                  </svg>
                  <span class="font-medium text-white">Submit an RFC</span>
                </div>
                <p class="text-sm text-text-muted">Propose changes or improvements to the protocol.</p>
              </a>

              <a href="https://github.com/monadial/ash/issues?q=is%3Aissue+label%3Arfc" target="_blank" rel="noopener noreferrer" class="bg-bg-elevated border border-border rounded-lg p-4 hover:border-brand/50 transition-colors group">
                <div class="flex items-center gap-3 mb-2">
                  <svg class="w-5 h-5 text-text-muted group-hover:text-brand transition-colors" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/>
                  </svg>
                  <span class="font-medium text-white">View Discussions</span>
                </div>
                <p class="text-sm text-text-muted">See existing RFCs and join the conversation.</p>
              </a>
            </div>
          </div>

          <div class="mt-8 pt-6 border-t border-border text-center">
            <p class="text-text-muted text-sm">
              For detailed security analysis, see <a href="/security" class="text-brand hover:text-brand-light">Security Model</a>. For ethical considerations, see <a href="/ethics" class="text-brand hover:text-brand-light">Ethics Statement</a>.
            </p>
          </div>
        </section>
      </article>
    </div>
  </div>
</Layout>

<style>
  .prose-content h2 {
    scroll-margin-top: 6rem;
  }
  .prose-content h3 {
    scroll-margin-top: 6rem;
  }
</style>
