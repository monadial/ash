---
import Layout from '../layouts/Layout.astro'
import TableOfContents from '../components/TableOfContents.astro'
import Diagram from '../components/Diagram.astro'
import InfoBox from '../components/InfoBox.astro'

const tocItems = [
  { id: 'overview', title: 'Protocol Overview', children: [
    { id: 'otp', title: 'One-Time Pad' },
    { id: 'shannon', title: 'Perfect Secrecy' },
  ]},
  { id: 'architecture', title: 'System Architecture', children: [
    { id: 'core', title: 'Shared Rust Core' },
    { id: 'apps', title: 'Mobile Applications' },
    { id: 'backend', title: 'Backend Relay' },
  ]},
  { id: 'ceremony', title: 'Ceremony Protocol', children: [
    { id: 'ceremony-flow', title: 'Ceremony Flow' },
    { id: 'passphrase', title: 'Mandatory Passphrase' },
    { id: 'mnemonic', title: 'Mnemonic Verification' },
    { id: 'pad-sizes', title: 'Pad Sizes' },
  ]},
  { id: 'framing', title: 'Frame Format', children: [
    { id: 'basic-frame', title: 'Basic Frame' },
    { id: 'extended-frame', title: 'Extended Frame' },
  ]},
  { id: 'messages', title: 'Messaging Protocol', children: [
    { id: 'message-frame', title: 'Message Frame' },
    { id: 'encryption-flow', title: 'Message Processing' },
    { id: 'bidirectional', title: 'Bidirectional Consumption' },
    { id: 'message-types', title: 'Message Types' },
  ]},
  { id: 'tokens', title: 'Token Derivation' },
  { id: 'trust', title: 'Trust Boundaries' },
]
---

<Layout title="Whitepaper" description="ASH Protocol technical specification. One-Time Pad encryption, ceremony protocol, and frame format.">
  <div class="py-16 sm:py-24">
    <!-- Header -->
    <div class="text-center mb-16">
      <span class="inline-block px-4 py-1.5 bg-brand-subtle text-brand-light text-xs font-semibold uppercase tracking-wider rounded-full mb-6">
        Technical Specification
      </span>
      <h1 class="text-4xl sm:text-5xl font-bold mb-4">ASH Protocol Whitepaper</h1>
      <p class="text-text-secondary text-lg max-w-2xl mx-auto">
        A comprehensive technical overview of the ASH secure messaging protocol, including architecture, ceremony specification, and frame format.
      </p>
    </div>

    <!-- Main content with TOC -->
    <div class="lg:grid lg:grid-cols-[240px_1fr] lg:gap-12">
      <!-- Table of Contents (sticky sidebar) -->
      <aside class="hidden lg:block">
        <TableOfContents items={tocItems} />
      </aside>

      <!-- Content -->
      <article class="prose-content space-y-16">
        <!-- Protocol Overview -->
        <section id="overview">
          <h2 class="text-2xl font-bold mb-6 pb-2 border-b border-border">Protocol Overview</h2>

          <div id="otp" class="mb-8">
            <h3 class="text-xl font-semibold mb-4">One-Time Pad Encryption</h3>
            <p class="text-text-secondary mb-4">
              ASH uses the One-Time Pad (OTP) cipher, the only encryption method proven to provide <strong class="text-white">information-theoretic security</strong>. Unlike computational security (used by AES, RSA, and modern cryptography), OTP security does not depend on mathematical assumptions or computational hardness.
            </p>
            <p class="text-text-secondary mb-4">
              The encryption is simple: each message byte is XOR'd with a corresponding key byte that is:
            </p>
            <ul class="list-disc list-inside text-text-secondary mb-4 space-y-1">
              <li>Truly random (from entropy sources)</li>
              <li>As long as the message</li>
              <li>Never reused (consumed after use)</li>
              <li>Known only to the two parties</li>
            </ul>

            <Diagram title="OTP Encryption">
{`Plaintext:  H   E   L   L   O      (message bytes)
               ⊕   ⊕   ⊕   ⊕   ⊕      (XOR operation)
Key:        7   K   2   X   9      (random key bytes)
               =   =   =   =   =
Ciphertext: ?   ?   ?   ?   ?      (encrypted bytes)`}
            </Diagram>
          </div>

          <div id="shannon" class="mb-8">
            <h3 class="text-xl font-semibold mb-4">Shannon's Perfect Secrecy</h3>
            <p class="text-text-secondary mb-4">
              In 1949, Claude Shannon mathematically proved that OTP provides "perfect secrecy": the ciphertext reveals absolutely nothing about the plaintext to an attacker without the key.
            </p>

            <InfoBox>
              <p class="text-sm">
                <strong class="text-white">Formal definition:</strong> A cipher has perfect secrecy if for all plaintexts M and ciphertexts C: P(M|C) = P(M). The probability of any plaintext given the ciphertext equals its prior probability.
              </p>
            </InfoBox>

            <p class="text-text-secondary mt-4">
              This means that without the key, every possible plaintext is equally likely. "HELLO" could decrypt to "WORLD", "PIZZA", or any other 5-letter combination. No amount of computation—not even quantum computers—can determine the original message.
            </p>
          </div>
        </section>

        <!-- System Architecture -->
        <section id="architecture">
          <h2 class="text-2xl font-bold mb-6 pb-2 border-b border-border">System Architecture</h2>

          <p class="text-text-secondary mb-6">
            ASH consists of four primary subsystems with explicitly defined trust boundaries. Security emerges from clear component separation and minimal infrastructure trust.
          </p>

          <Diagram title="System Overview">
{`┌────────────┐
│   Users    │
└─────┬──────┘
      │
┌─────▼──────┐
│  iOS App   │  (SwiftUI presentation layer)
└─────┬──────┘
      │  FFI boundary (UniFFI bindings)
┌─────▼──────┐
│   core     │  (Shared Rust Core - cryptographic authority)
└─────┬──────┘
      │
┌─────▼──────┐
│  Backend   │  (Rust Relay - stateless, untrusted)
└────────────┘`}
          </Diagram>

          <div id="core" class="mt-8 mb-8">
            <h3 class="text-xl font-semibold mb-4">Shared Rust Core (ash-core)</h3>
            <p class="text-text-secondary mb-4">
              The core is the <strong class="text-white">cryptographic and procedural authority</strong> of ASH. All security-sensitive behavior is defined here, and all other components must treat it as authoritative.
            </p>

            <div class="bg-bg-card border border-border rounded-lg overflow-hidden mb-4">
              <div class="px-4 py-2 border-b border-border bg-bg-elevated">
                <span class="text-xs font-medium text-text-secondary">Core Responsibilities</span>
              </div>
              <ul class="p-4 space-y-2 text-sm text-text-secondary">
                <li>• One-Time Pad creation and management</li>
                <li>• Strict pad single-use semantics enforcement</li>
                <li>• Bidirectional pad consumption (Initiator/Responder)</li>
                <li>• OTP encryption and decryption</li>
                <li>• <strong class="text-white">Wegman-Carter 256-bit message authentication</strong></li>
                <li>• <strong class="text-white">GF(2^128) polynomial hashing</strong></li>
                <li>• <strong class="text-white">Mandatory 32-byte message padding</strong></li>
                <li>• Ceremony rules and frame encoding/decoding</li>
                <li>• CRC-32 integrity validation</li>
                <li>• Authorization token derivation</li>
                <li>• Mnemonic checksum generation (6 words, 512-word wordlist)</li>
                <li>• Best-effort memory wiping</li>
              </ul>
            </div>

            <InfoBox variant="warning">
              <p class="text-sm">
                <strong>ash-core must never:</strong> access the network, perform I/O, access OS randomness directly, contain platform-specific code, store data, include UI logic, or log sensitive data.
              </p>
            </InfoBox>
          </div>

          <div id="apps" class="mb-8">
            <h3 class="text-xl font-semibold mb-4">Mobile Applications</h3>
            <p class="text-text-secondary mb-4">
              The iOS application (Android planned) is a <strong class="text-white">presentation and orchestration layer</strong>. It invokes core functionality via UniFFI-generated Swift bindings and manages the user interface.
            </p>
            <p class="text-text-secondary mb-4">
              Mobile apps must never: reimplement cryptographic logic, alter OTP behavior, bypass the shared core, invent alternate checksums, persist decrypted messages, or perform silent background actions.
            </p>
          </div>

          <div id="backend" class="mb-8">
            <h3 class="text-xl font-semibold mb-4">Backend Relay</h3>
            <p class="text-text-secondary mb-4">
              The backend is a <strong class="text-white">stateless RAM-only relay</strong>. It is intentionally simple and considered untrusted. Messages are held only in memory until ACK or TTL expiry.
            </p>

            <Diagram title="Message Flow">
{`Alice                    Server (RAM)                    Bob
  │                          │                              │
  │  POST /v1/messages       │                              │
  ├─────────────────────────►│  (store, start TTL)          │
  │◄── {blob_id} ────────────│                              │
  │                          │───── SSE: message ──────────►│
  │                          │                     (decrypt) │
  │                          │◄─── POST /v1/ack ────────────│
  │◄── SSE: delivered ───────│  (delete from RAM)           │`}
            </Diagram>

            <p class="text-text-secondary mt-4">
              Backend must never: persist messages to disk, decrypt messages, inspect payload contents, identify users, store data long-term, or implement business logic.
            </p>
          </div>
        </section>

        <!-- Ceremony Protocol -->
        <section id="ceremony">
          <h2 class="text-2xl font-bold mb-6 pb-2 border-b border-border">Ceremony Protocol</h2>

          <p class="text-text-secondary mb-6">
            The ceremony establishes a shared One-Time Pad between two devices. It is designed to be <strong class="text-white">offline</strong>, <strong class="text-white">explicit</strong>, <strong class="text-white">human-verifiable</strong>, and <strong class="text-white">atomic</strong>.
          </p>

          <div id="ceremony-flow" class="mb-8">
            <h3 class="text-xl font-semibold mb-4">Ceremony Flow</h3>

            <div class="bg-bg-card border border-border rounded-lg overflow-hidden">
              <div class="divide-y divide-border">
                <div class="p-4">
                  <div class="flex items-start gap-4">
                    <span class="flex-shrink-0 w-8 h-8 bg-brand rounded-lg flex items-center justify-center text-white font-bold text-sm">1</span>
                    <div>
                      <h4 class="font-medium mb-1">Pad Size Selection</h4>
                      <p class="text-text-secondary text-sm">Sender selects pad size via slider, determining message capacity and ceremony duration.</p>
                    </div>
                  </div>
                </div>
                <div class="p-4">
                  <div class="flex items-start gap-4">
                    <span class="flex-shrink-0 w-8 h-8 bg-brand rounded-lg flex items-center justify-center text-white font-bold text-sm">2</span>
                    <div>
                      <h4 class="font-medium mb-1">Entropy Collection</h4>
                      <p class="text-text-secondary text-sm">OS randomness mixed with required gesture input. User draws patterns while entropy accumulates visually.</p>
                    </div>
                  </div>
                </div>
                <div class="p-4">
                  <div class="flex items-start gap-4">
                    <span class="flex-shrink-0 w-8 h-8 bg-brand rounded-lg flex items-center justify-center text-white font-bold text-sm">3</span>
                    <div>
                      <h4 class="font-medium mb-1">Passphrase Exchange</h4>
                      <p class="text-text-secondary text-sm">Both parties agree on a shared passphrase (minimum 4 characters). This encrypts QR frames to protect against visual observation.</p>
                    </div>
                  </div>
                </div>
                <div class="p-4">
                  <div class="flex items-start gap-4">
                    <span class="flex-shrink-0 w-8 h-8 bg-brand rounded-lg flex items-center justify-center text-white font-bold text-sm">4</span>
                    <div>
                      <h4 class="font-medium mb-1">QR Transfer</h4>
                      <p class="text-text-secondary text-sm">Sender displays passphrase-encrypted QR codes. Receiver scans frames, decrypts, validates CRC, and acknowledges.</p>
                    </div>
                  </div>
                </div>
                <div class="p-4">
                  <div class="flex items-start gap-4">
                    <span class="flex-shrink-0 w-8 h-8 bg-brand rounded-lg flex items-center justify-center text-white font-bold text-sm">5</span>
                    <div>
                      <h4 class="font-medium mb-1">Mnemonic Verification</h4>
                      <p class="text-text-secondary text-sm">Both devices display 6-word checksum. Users verbally confirm match to detect tampering.</p>
                    </div>
                  </div>
                </div>
                <div class="p-4">
                  <div class="flex items-start gap-4">
                    <span class="flex-shrink-0 w-8 h-8 bg-success rounded-lg flex items-center justify-center text-white font-bold text-sm">6</span>
                    <div>
                      <h4 class="font-medium mb-1">Activation</h4>
                      <p class="text-text-secondary text-sm">Tokens derived from pad. Conversation becomes active. Messaging available.</p>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div id="passphrase" class="mb-8">
            <h3 class="text-xl font-semibold mb-4">Mandatory Passphrase Protection</h3>
            <p class="text-text-secondary mb-4">
              Every ceremony requires a <strong class="text-white">mandatory passphrase</strong> that encrypts QR frames during transfer. This protects against visual observation attacks.
            </p>

            <div class="bg-bg-card border border-border rounded-lg overflow-hidden mb-4">
              <table class="w-full text-sm">
                <thead>
                  <tr class="border-b border-border bg-bg-elevated">
                    <th class="text-left p-3 text-text-muted font-medium">Property</th>
                    <th class="text-left p-3 text-text-muted font-medium">Requirement</th>
                  </tr>
                </thead>
                <tbody class="divide-y divide-border">
                  <tr><td class="p-3">Minimum length</td><td class="p-3 text-text-secondary">4 characters</td></tr>
                  <tr><td class="p-3">Exchange method</td><td class="p-3 text-text-secondary">Verbal (spoken between parties)</td></tr>
                  <tr><td class="p-3">Key derivation</td><td class="p-3 text-text-secondary">SHA-256 hash of passphrase</td></tr>
                  <tr><td class="p-3">Frame encryption</td><td class="p-3 text-text-secondary">XOR with derived key stream</td></tr>
                </tbody>
              </table>
            </div>

            <InfoBox>
              <p class="text-sm">
                <strong class="text-white">Defense in depth:</strong> The passphrase adds a second layer of protection. Even if QR codes are visually captured, the attacker cannot reconstruct the pad without the passphrase. Both parties must enter the same passphrase for the ceremony to succeed.
              </p>
            </InfoBox>
          </div>

          <div id="mnemonic" class="mb-8">
            <h3 class="text-xl font-semibold mb-4">Mnemonic Verification</h3>
            <p class="text-text-secondary mb-4">
              The mnemonic checksum allows human verification that both devices have identical pads.
            </p>

            <div class="bg-bg-card border border-border rounded-lg overflow-hidden">
              <table class="w-full text-sm">
                <thead>
                  <tr class="border-b border-border bg-bg-elevated">
                    <th class="text-left p-3 text-text-muted font-medium">Property</th>
                    <th class="text-left p-3 text-text-muted font-medium">Value</th>
                  </tr>
                </thead>
                <tbody class="divide-y divide-border">
                  <tr><td class="p-3">Wordlist size</td><td class="p-3 text-text-secondary">512 words (custom, not BIP-39)</td></tr>
                  <tr><td class="p-3">Bits per word</td><td class="p-3 text-text-secondary">9 bits (512 = 2^9)</td></tr>
                  <tr><td class="p-3">Word count</td><td class="p-3 text-text-secondary">6 words</td></tr>
                  <tr><td class="p-3">Verification entropy</td><td class="p-3 text-text-secondary">54 bits</td></tr>
                  <tr><td class="p-3">Word format</td><td class="p-3 text-text-secondary">3-7 characters, lowercase ASCII</td></tr>
                </tbody>
              </table>
            </div>

            <p class="text-text-secondary mt-4 text-sm">
              Words are optimized for verbal clarity: distinct pronunciation, no homophones, minimal confusion between similar words, and cross-language usability.
            </p>
          </div>

          <div id="pad-sizes" class="mb-8">
            <h3 class="text-xl font-semibold mb-4">Pad Size Options</h3>

            <p class="text-text-secondary mb-4">
              ASH supports both preset sizes and <strong class="text-white">custom pad sizes</strong> from 32 KB to 10 MB. Larger pads support more messages but require longer ceremony transfer times.
            </p>

            <div class="bg-bg-card border border-border rounded-lg overflow-x-auto mb-4">
              <table class="w-full text-sm">
                <thead>
                  <tr class="border-b border-border bg-bg-elevated">
                    <th class="text-left p-3 text-text-muted font-medium">Size</th>
                    <th class="text-left p-3 text-text-muted font-medium">Bytes</th>
                    <th class="text-left p-3 text-text-muted font-medium">Capacity*</th>
                    <th class="text-left p-3 text-text-muted font-medium">Frames</th>
                  </tr>
                </thead>
                <tbody class="divide-y divide-border">
                  <tr><td class="p-3">Small (64 KB)</td><td class="p-3 text-text-secondary">65,536</td><td class="p-3 text-text-secondary">~400 messages</td><td class="p-3 text-text-secondary">~44</td></tr>
                  <tr><td class="p-3">Medium (256 KB)</td><td class="p-3 text-text-secondary">262,144</td><td class="p-3 text-text-secondary">~1,600 messages</td><td class="p-3 text-text-secondary">~175</td></tr>
                  <tr><td class="p-3">Large (512 KB)</td><td class="p-3 text-text-secondary">524,288</td><td class="p-3 text-text-secondary">~3,200 messages</td><td class="p-3 text-text-secondary">~350</td></tr>
                  <tr><td class="p-3">Huge (1 MB)</td><td class="p-3 text-text-secondary">1,048,576</td><td class="p-3 text-text-secondary">~6,400 messages</td><td class="p-3 text-text-secondary">~700</td></tr>
                  <tr><td class="p-3">Custom</td><td class="p-3 text-text-secondary">32 KB – 10 MB</td><td class="p-3 text-text-secondary">User-specified</td><td class="p-3 text-text-secondary">Variable</td></tr>
                </tbody>
              </table>
            </div>

            <p class="text-text-muted text-xs">
              * Message capacity calculated as: (pad_bytes - 160) / 96 bytes per message (64 bytes auth key + 32 bytes minimum padded message)
            </p>
          </div>
        </section>

        <!-- Frame Format -->
        <section id="framing">
          <h2 class="text-2xl font-bold mb-6 pb-2 border-b border-border">Frame Format Specification</h2>

          <p class="text-text-secondary mb-6">
            Frames chunk large pad data into scannable QR codes, provide integrity verification per chunk, and enable ordered reconstruction.
          </p>

          <div id="basic-frame" class="mb-8">
            <h3 class="text-xl font-semibold mb-4">Basic Frame Structure</h3>

            <Diagram title="Frame Layout">
{`+------------------+------------------+------------------+------------------+
|   Frame Index    |   Total Frames   |   Payload        |   CRC-32         |
|   (2 bytes BE)   |   (2 bytes BE)   |   (N bytes)      |   (4 bytes BE)   |
+------------------+------------------+------------------+------------------+`}
            </Diagram>

            <div class="bg-bg-card border border-border rounded-lg overflow-hidden mt-4">
              <table class="w-full text-sm">
                <thead>
                  <tr class="border-b border-border bg-bg-elevated">
                    <th class="text-left p-3 text-text-muted font-medium">Field</th>
                    <th class="text-left p-3 text-text-muted font-medium">Size</th>
                    <th class="text-left p-3 text-text-muted font-medium">Description</th>
                  </tr>
                </thead>
                <tbody class="divide-y divide-border">
                  <tr><td class="p-3 font-mono text-xs">Frame Index</td><td class="p-3 text-text-secondary">2 bytes</td><td class="p-3 text-text-secondary">Zero-based index (big-endian)</td></tr>
                  <tr><td class="p-3 font-mono text-xs">Total Frames</td><td class="p-3 text-text-secondary">2 bytes</td><td class="p-3 text-text-secondary">Total frames in sequence (big-endian)</td></tr>
                  <tr><td class="p-3 font-mono text-xs">Payload</td><td class="p-3 text-text-secondary">Variable</td><td class="p-3 text-text-secondary">Pad bytes (max 1000 bytes)</td></tr>
                  <tr><td class="p-3 font-mono text-xs">CRC-32</td><td class="p-3 text-text-secondary">4 bytes</td><td class="p-3 text-text-secondary">CRC of preceding bytes (ISO 3309)</td></tr>
                </tbody>
              </table>
            </div>
          </div>

          <div id="extended-frame" class="mb-8">
            <h3 class="text-xl font-semibold mb-4">Extended Frame Format</h3>

            <p class="text-text-secondary mb-4">
              For ceremony transfer, an extended format includes metadata and optional encryption.
            </p>

            <Diagram title="Extended Frame">
{`+-------+-------+------------------+------------------+------------------+------------------+
| Magic | Flags | Frame Index      | Total Frames     | Payload          | CRC-32           |
| (1B)  | (1B)  | (2 bytes BE)     | (2 bytes BE)     | (max 1500B)      | (4 bytes BE)     |
+-------+-------+------------------+------------------+------------------+------------------+

Magic: 0xA5 (identifies extended format)
Flags: Bit 0 = ENCRYPTED, Bit 1 = METADATA`}
            </Diagram>

            <h4 class="font-medium mt-6 mb-3">Ceremony Metadata (Frame 0)</h4>
            <p class="text-text-secondary mb-4 text-sm">
              When METADATA flag is set, frame 0 contains ceremony settings:
            </p>

            <div class="bg-bg-card border border-border rounded-lg p-4 font-mono text-xs text-text-secondary">
              [version: u8][ttl: u64 BE][disappearing: u32 BE][url_len: u16 BE][url: bytes]
            </div>
          </div>
        </section>

        <!-- Messaging Protocol -->
        <section id="messages">
          <h2 class="text-2xl font-bold mb-6 pb-2 border-b border-border">Messaging Protocol</h2>

          <p class="text-text-secondary mb-6">
            ASH messages combine <strong class="text-white">OTP encryption</strong>, <strong class="text-white">Wegman-Carter authentication</strong>, and <strong class="text-white">mandatory padding</strong> into a single authenticated frame. Every message provides both information-theoretic confidentiality and information-theoretic authentication.
          </p>

          <div id="message-frame" class="mb-8">
            <h3 class="text-xl font-semibold mb-4">Authenticated Message Frame</h3>

            <p class="text-text-secondary mb-4">
              All messages use this single frame format. The relay receives and stores these frames as opaque blobs.
            </p>

            <Diagram title="Message Frame Structure">
{`┌──────────┬──────────┬──────────┬──────────────────┬──────────────────┐
│ Version  │   Type   │  Length  │   Ciphertext     │   Auth Tag       │
│  (1 B)   │  (1 B)   │ (2 B BE) │   (N bytes)      │   (32 bytes)     │
└──────────┴──────────┴──────────┴──────────────────┴──────────────────┘
     │          │          │              │                   │
     │          │          │              │                   └─ Wegman-Carter 256-bit MAC
     │          │          │              └─ OTP-encrypted padded plaintext
     │          │          └─ Ciphertext length (big-endian)
     │          └─ Message type: 0x00=text, 0x01=location
     └─ Protocol version (currently 1)

Minimum frame size: 4 (header) + 32 (min ciphertext) + 32 (tag) = 68 bytes`}
            </Diagram>

            <div class="bg-bg-card border border-border rounded-lg overflow-hidden mt-4">
              <table class="w-full text-sm">
                <thead>
                  <tr class="border-b border-border bg-bg-elevated">
                    <th class="text-left p-3 text-text-muted font-medium">Field</th>
                    <th class="text-left p-3 text-text-muted font-medium">Size</th>
                    <th class="text-left p-3 text-text-muted font-medium">Description</th>
                  </tr>
                </thead>
                <tbody class="divide-y divide-border">
                  <tr><td class="p-3 font-mono text-xs">version</td><td class="p-3 text-text-secondary">1 byte</td><td class="p-3 text-text-secondary">Protocol version (1)</td></tr>
                  <tr><td class="p-3 font-mono text-xs">type</td><td class="p-3 text-text-secondary">1 byte</td><td class="p-3 text-text-secondary">0x00 = text, 0x01 = location</td></tr>
                  <tr><td class="p-3 font-mono text-xs">length</td><td class="p-3 text-text-secondary">2 bytes</td><td class="p-3 text-text-secondary">Ciphertext length (big-endian)</td></tr>
                  <tr><td class="p-3 font-mono text-xs">ciphertext</td><td class="p-3 text-text-secondary">≥32 bytes</td><td class="p-3 text-text-secondary">OTP-encrypted padded plaintext</td></tr>
                  <tr><td class="p-3 font-mono text-xs">auth_tag</td><td class="p-3 text-text-secondary">32 bytes</td><td class="p-3 text-text-secondary">Wegman-Carter 256-bit authentication tag</td></tr>
                </tbody>
              </table>
            </div>

            <h4 class="font-medium mt-6 mb-3">Pad Consumption Per Message</h4>
            <div class="bg-bg-card border border-border rounded-lg overflow-hidden">
              <table class="w-full text-sm">
                <thead>
                  <tr class="border-b border-border bg-bg-elevated">
                    <th class="text-left p-3 text-text-muted font-medium">Component</th>
                    <th class="text-left p-3 text-text-muted font-medium">Size</th>
                    <th class="text-left p-3 text-text-muted font-medium">Purpose</th>
                  </tr>
                </thead>
                <tbody class="divide-y divide-border">
                  <tr><td class="p-3">Auth key (r₁, r₂, s₁, s₂)</td><td class="p-3 text-text-secondary">64 bytes</td><td class="p-3 text-text-secondary">Wegman-Carter MAC computation</td></tr>
                  <tr><td class="p-3">Encryption key</td><td class="p-3 text-text-secondary">≥32 bytes</td><td class="p-3 text-text-secondary">OTP encryption (= padded plaintext length)</td></tr>
                  <tr><td class="p-3 font-semibold">Total minimum</td><td class="p-3 text-text-secondary font-semibold">96 bytes</td><td class="p-3 text-text-secondary">Per message (64 + 32)</td></tr>
                </tbody>
              </table>
            </div>
          </div>

          <div id="encryption-flow" class="mb-8">
            <h3 class="text-xl font-semibold mb-4">Message Processing</h3>

            <p class="text-text-secondary mb-6">
              Every message passes through a symmetric pipeline that provides both confidentiality and authentication.
            </p>

            <!-- Sender Section -->
            <div class="flex items-center gap-3 mb-4">
              <div class="w-10 h-10 rounded-full bg-brand/20 flex items-center justify-center">
                <svg class="w-5 h-5 text-brand" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M7 11l5-5m0 0l5 5m-5-5v12" />
                </svg>
              </div>
              <div>
                <h4 class="font-semibold text-white">Sender: Encryption</h4>
                <p class="text-text-muted text-sm">Pad → Encrypt → Authenticate → Send</p>
              </div>
            </div>

            <!-- Encryption Pipeline - HTML Version -->
            <div class="bg-bg-card border border-border rounded-xl overflow-hidden mb-8">
              <div class="p-6 space-y-6">

                <!-- Step 1: Padding -->
                <div class="relative">
                  <div class="flex items-center gap-3 mb-3">
                    <span class="flex-shrink-0 w-8 h-8 bg-brand rounded-lg flex items-center justify-center text-white font-bold text-sm">1</span>
                    <div>
                      <h5 class="font-semibold text-white">Padding</h5>
                      <p class="text-text-muted text-xs">Traffic Analysis Protection</p>
                    </div>
                  </div>
                  <div class="ml-11 bg-bg-elevated rounded-lg p-4">
                    <div class="text-sm text-text-secondary mb-2">Input: <code class="text-brand">"hi"</code> (2 bytes)</div>
                    <div class="flex flex-wrap gap-1 font-mono text-xs mb-2">
                      <span class="px-2 py-1 bg-warning/20 text-warning rounded">00</span>
                      <span class="px-2 py-1 bg-brand/20 text-brand-light rounded">00 02</span>
                      <span class="px-2 py-1 bg-success/20 text-success rounded">68 69</span>
                      <span class="px-2 py-1 bg-bg-card text-text-muted rounded">00 00 00 ...</span>
                    </div>
                    <div class="flex flex-wrap gap-4 text-xs text-text-muted">
                      <span><span class="inline-block w-2 h-2 bg-warning/50 rounded mr-1"></span>marker</span>
                      <span><span class="inline-block w-2 h-2 bg-brand/50 rounded mr-1"></span>length</span>
                      <span><span class="inline-block w-2 h-2 bg-success/50 rounded mr-1"></span>"hi"</span>
                      <span><span class="inline-block w-2 h-2 bg-bg-card rounded mr-1 border border-border"></span>zero padding</span>
                    </div>
                    <div class="text-sm text-text-secondary mt-2">Output: <strong class="text-white">32 bytes</strong> (minimum for all messages)</div>
                  </div>
                  <div class="absolute left-4 top-14 bottom-0 w-px bg-border -z-10"></div>
                </div>

                <!-- Arrow -->
                <div class="ml-11 flex items-center gap-2 text-text-muted">
                  <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 14l-7 7m0 0l-7-7m7 7V3" /></svg>
                  <span class="text-xs">padded plaintext</span>
                </div>

                <!-- Step 2: Encryption -->
                <div class="relative">
                  <div class="flex items-center gap-3 mb-3">
                    <span class="flex-shrink-0 w-8 h-8 bg-brand rounded-lg flex items-center justify-center text-white font-bold text-sm">2</span>
                    <div>
                      <h5 class="font-semibold text-white">OTP Encryption</h5>
                      <p class="text-text-muted text-xs">Perfect Secrecy</p>
                    </div>
                  </div>
                  <div class="ml-11 bg-bg-elevated rounded-lg p-4">
                    <div class="space-y-2 font-mono text-xs">
                      <div class="flex items-center gap-2">
                        <span class="text-text-muted w-24">Plaintext:</span>
                        <span class="text-text-secondary">00 00 02 68 69 00 00 ...</span>
                        <span class="text-text-muted">(32 bytes)</span>
                      </div>
                      <div class="flex items-center gap-2">
                        <span class="text-text-muted w-24"></span>
                        <span class="text-brand text-lg">⊕</span>
                        <span class="text-text-muted text-xs">XOR</span>
                      </div>
                      <div class="flex items-center gap-2">
                        <span class="text-text-muted w-24">Pad key:</span>
                        <span class="text-success">A3 F1 2B 9E 07 C4 D8 ...</span>
                        <span class="text-text-muted">(32 bytes from pad)</span>
                      </div>
                      <div class="flex items-center gap-2 pt-2 border-t border-border">
                        <span class="text-text-muted w-24">Ciphertext:</span>
                        <span class="text-warning">A3 F1 29 F6 6E C4 D8 ...</span>
                        <span class="text-text-muted">(32 bytes)</span>
                      </div>
                    </div>
                  </div>
                  <div class="absolute left-4 top-14 bottom-0 w-px bg-border -z-10"></div>
                </div>

                <!-- Arrow -->
                <div class="ml-11 flex items-center gap-2 text-text-muted">
                  <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 14l-7 7m0 0l-7-7m7 7V3" /></svg>
                  <span class="text-xs">ciphertext</span>
                </div>

                <!-- Step 3: Authentication -->
                <div class="relative">
                  <div class="flex items-center gap-3 mb-3">
                    <span class="flex-shrink-0 w-8 h-8 bg-brand rounded-lg flex items-center justify-center text-white font-bold text-sm">3</span>
                    <div>
                      <h5 class="font-semibold text-white">Wegman-Carter MAC</h5>
                      <p class="text-text-muted text-xs">Information-Theoretic Authentication</p>
                    </div>
                  </div>
                  <div class="ml-11 bg-bg-elevated rounded-lg p-4">
                    <div class="text-sm text-text-secondary mb-3">Auth key from pad (64 bytes):</div>
                    <div class="flex flex-wrap gap-1 font-mono text-xs mb-3">
                      <span class="px-3 py-1.5 bg-brand/20 text-brand-light rounded">r₁ (16B)</span>
                      <span class="px-3 py-1.5 bg-brand/20 text-brand-light rounded">r₂ (16B)</span>
                      <span class="px-3 py-1.5 bg-success/20 text-success rounded">s₁ (16B)</span>
                      <span class="px-3 py-1.5 bg-success/20 text-success rounded">s₂ (16B)</span>
                    </div>
                    <div class="text-xs text-text-muted mb-2">Polynomial evaluation in GF(2^128):</div>
                    <div class="font-mono text-xs text-text-secondary space-y-1 mb-3">
                      <div>Tag₁ = Σ(blockᵢ · r₁<sup>n-i</sup>) ⊕ s₁</div>
                      <div>Tag₂ = Σ(blockᵢ · r₂<sup>n-i</sup>) ⊕ s₂</div>
                    </div>
                    <div class="text-sm text-text-secondary">Output: <strong class="text-white">Tag₁ ∥ Tag₂</strong> = 256-bit (32 bytes)</div>
                  </div>
                  <div class="absolute left-4 top-14 bottom-0 w-px bg-border -z-10"></div>
                </div>

                <!-- Arrow -->
                <div class="ml-11 flex items-center gap-2 text-text-muted">
                  <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 14l-7 7m0 0l-7-7m7 7V3" /></svg>
                  <span class="text-xs">authentication tag</span>
                </div>

                <!-- Step 4: Frame Assembly -->
                <div>
                  <div class="flex items-center gap-3 mb-3">
                    <span class="flex-shrink-0 w-8 h-8 bg-success rounded-lg flex items-center justify-center text-white font-bold text-sm">4</span>
                    <div>
                      <h5 class="font-semibold text-white">Frame Assembly</h5>
                      <p class="text-text-muted text-xs">Final Output</p>
                    </div>
                  </div>
                  <div class="ml-11 bg-bg-elevated rounded-lg p-4">
                    <div class="flex flex-wrap gap-1 font-mono text-xs mb-3">
                      <span class="px-2 py-1.5 bg-text-muted/20 text-text-secondary rounded border border-border">01</span>
                      <span class="px-2 py-1.5 bg-text-muted/20 text-text-secondary rounded border border-border">00</span>
                      <span class="px-2 py-1.5 bg-text-muted/20 text-text-secondary rounded border border-border">00 20</span>
                      <span class="px-4 py-1.5 bg-warning/20 text-warning rounded">ciphertext (32B)</span>
                      <span class="px-4 py-1.5 bg-brand/20 text-brand-light rounded">auth tag (32B)</span>
                    </div>
                    <div class="flex flex-wrap gap-4 text-xs text-text-muted mb-3">
                      <span>version</span>
                      <span>type</span>
                      <span>length</span>
                      <span><span class="inline-block w-2 h-2 bg-warning/50 rounded mr-1"></span>encrypted</span>
                      <span><span class="inline-block w-2 h-2 bg-brand/50 rounded mr-1"></span>MAC</span>
                    </div>
                    <div class="text-sm text-success font-medium">Total: 68 bytes sent to relay</div>
                  </div>
                </div>

              </div>
            </div>

            <!-- Receiver Section -->
            <div class="flex items-center gap-3 mb-4">
              <div class="w-10 h-10 rounded-full bg-success/20 flex items-center justify-center">
                <svg class="w-5 h-5 text-success" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M17 13l-5 5m0 0l-5-5m5 5V6" />
                </svg>
              </div>
              <div>
                <h4 class="font-semibold text-white">Receiver: Decryption</h4>
                <p class="text-text-muted text-sm">Receive → Verify → Decrypt → Unpad</p>
              </div>
            </div>

            <!-- Decryption Pipeline - HTML Version -->
            <div class="bg-bg-card border border-border rounded-xl overflow-hidden mb-6">
              <div class="p-6 space-y-6">

                <!-- Step 1: Receive Frame -->
                <div class="relative">
                  <div class="flex items-center gap-3 mb-3">
                    <span class="flex-shrink-0 w-8 h-8 bg-brand rounded-lg flex items-center justify-center text-white font-bold text-sm">1</span>
                    <div>
                      <h5 class="font-semibold text-white">Receive Frame</h5>
                      <p class="text-text-muted text-xs">Parse authenticated message</p>
                    </div>
                  </div>
                  <div class="ml-11 bg-bg-elevated rounded-lg p-4">
                    <div class="flex flex-wrap gap-1 font-mono text-xs mb-3">
                      <span class="px-2 py-1.5 bg-text-muted/20 text-text-secondary rounded border border-border">01</span>
                      <span class="px-2 py-1.5 bg-text-muted/20 text-text-secondary rounded border border-border">00</span>
                      <span class="px-2 py-1.5 bg-text-muted/20 text-text-secondary rounded border border-border">00 20</span>
                      <span class="px-4 py-1.5 bg-warning/20 text-warning rounded">ciphertext (32B)</span>
                      <span class="px-4 py-1.5 bg-brand/20 text-brand-light rounded">auth tag (32B)</span>
                    </div>
                    <div class="text-sm text-text-secondary">Extract: header, ciphertext, and authentication tag</div>
                  </div>
                  <div class="absolute left-4 top-14 bottom-0 w-px bg-border -z-10"></div>
                </div>

                <!-- Arrow -->
                <div class="ml-11 flex items-center gap-2 text-text-muted">
                  <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 14l-7 7m0 0l-7-7m7 7V3" /></svg>
                  <span class="text-xs">ciphertext + received tag</span>
                </div>

                <!-- Step 2: Verify MAC -->
                <div class="relative">
                  <div class="flex items-center gap-3 mb-3">
                    <span class="flex-shrink-0 w-8 h-8 bg-brand rounded-lg flex items-center justify-center text-white font-bold text-sm">2</span>
                    <div>
                      <h5 class="font-semibold text-white">Verify Wegman-Carter MAC</h5>
                      <p class="text-text-muted text-xs">Reject if tampered</p>
                    </div>
                  </div>
                  <div class="ml-11 bg-bg-elevated rounded-lg p-4">
                    <div class="text-sm text-text-secondary mb-3">Consume auth key from pad (64 bytes):</div>
                    <div class="flex flex-wrap gap-1 font-mono text-xs mb-3">
                      <span class="px-3 py-1.5 bg-brand/20 text-brand-light rounded">r₁ (16B)</span>
                      <span class="px-3 py-1.5 bg-brand/20 text-brand-light rounded">r₂ (16B)</span>
                      <span class="px-3 py-1.5 bg-success/20 text-success rounded">s₁ (16B)</span>
                      <span class="px-3 py-1.5 bg-success/20 text-success rounded">s₂ (16B)</span>
                    </div>
                    <div class="font-mono text-xs text-text-secondary space-y-1 mb-3">
                      <div>Computed Tag = Σ(blockᵢ · r<sup>n-i</sup>) ⊕ s</div>
                    </div>
                    <div class="flex items-center gap-3">
                      <div class="flex items-center gap-2 px-3 py-1.5 bg-success/10 border border-success/30 rounded text-xs">
                        <svg class="w-4 h-4 text-success" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg>
                        <span class="text-success">computed_tag == received_tag → valid</span>
                      </div>
                      <div class="flex items-center gap-2 px-3 py-1.5 bg-danger/10 border border-danger/30 rounded text-xs">
                        <svg class="w-4 h-4 text-danger" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                        <span class="text-danger">mismatch → reject</span>
                      </div>
                    </div>
                  </div>
                  <div class="absolute left-4 top-14 bottom-0 w-px bg-border -z-10"></div>
                </div>

                <!-- Arrow -->
                <div class="ml-11 flex items-center gap-2 text-text-muted">
                  <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 14l-7 7m0 0l-7-7m7 7V3" /></svg>
                  <span class="text-xs">verified ciphertext</span>
                </div>

                <!-- Step 3: Decrypt -->
                <div class="relative">
                  <div class="flex items-center gap-3 mb-3">
                    <span class="flex-shrink-0 w-8 h-8 bg-brand rounded-lg flex items-center justify-center text-white font-bold text-sm">3</span>
                    <div>
                      <h5 class="font-semibold text-white">OTP Decryption</h5>
                      <p class="text-text-muted text-xs">XOR is symmetric</p>
                    </div>
                  </div>
                  <div class="ml-11 bg-bg-elevated rounded-lg p-4">
                    <div class="space-y-2 font-mono text-xs">
                      <div class="flex items-center gap-2">
                        <span class="text-text-muted w-24">Ciphertext:</span>
                        <span class="text-warning">A3 F1 29 F6 6E C4 D8 ...</span>
                        <span class="text-text-muted">(32 bytes)</span>
                      </div>
                      <div class="flex items-center gap-2">
                        <span class="text-text-muted w-24"></span>
                        <span class="text-brand text-lg">⊕</span>
                        <span class="text-text-muted text-xs">XOR (same operation)</span>
                      </div>
                      <div class="flex items-center gap-2">
                        <span class="text-text-muted w-24">Pad key:</span>
                        <span class="text-success">A3 F1 2B 9E 07 C4 D8 ...</span>
                        <span class="text-text-muted">(32 bytes from pad)</span>
                      </div>
                      <div class="flex items-center gap-2 pt-2 border-t border-border">
                        <span class="text-text-muted w-24">Plaintext:</span>
                        <span class="text-text-secondary">00 00 02 68 69 00 00 ...</span>
                        <span class="text-text-muted">(32 bytes padded)</span>
                      </div>
                    </div>
                  </div>
                  <div class="absolute left-4 top-14 bottom-0 w-px bg-border -z-10"></div>
                </div>

                <!-- Arrow -->
                <div class="ml-11 flex items-center gap-2 text-text-muted">
                  <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 14l-7 7m0 0l-7-7m7 7V3" /></svg>
                  <span class="text-xs">padded plaintext</span>
                </div>

                <!-- Step 4: Remove Padding -->
                <div>
                  <div class="flex items-center gap-3 mb-3">
                    <span class="flex-shrink-0 w-8 h-8 bg-success rounded-lg flex items-center justify-center text-white font-bold text-sm">4</span>
                    <div>
                      <h5 class="font-semibold text-white">Remove Padding</h5>
                      <p class="text-text-muted text-xs">Extract original message</p>
                    </div>
                  </div>
                  <div class="ml-11 bg-bg-elevated rounded-lg p-4">
                    <div class="flex flex-wrap gap-1 font-mono text-xs mb-3">
                      <span class="px-2 py-1 bg-warning/20 text-warning rounded">00</span>
                      <span class="px-2 py-1 bg-brand/20 text-brand-light rounded">00 02</span>
                      <span class="px-2 py-1 bg-success/20 text-success rounded">68 69</span>
                      <span class="px-2 py-1 bg-bg-card text-text-muted rounded line-through">00 00 00 ...</span>
                    </div>
                    <div class="flex flex-wrap gap-4 text-xs text-text-muted mb-3">
                      <span><span class="inline-block w-2 h-2 bg-warning/50 rounded mr-1"></span>marker (0x00)</span>
                      <span><span class="inline-block w-2 h-2 bg-brand/50 rounded mr-1"></span>length = 2</span>
                      <span><span class="inline-block w-2 h-2 bg-success/50 rounded mr-1"></span>content</span>
                      <span><span class="inline-block w-2 h-2 bg-bg-card rounded mr-1 border border-border"></span>discard padding</span>
                    </div>
                    <div class="text-sm text-success font-medium">Output: <code class="bg-success/20 px-2 py-0.5 rounded">"hi"</code> (2 bytes)</div>
                  </div>
                </div>

              </div>
            </div>

            <h4 class="font-medium mt-6 mb-3">Wegman-Carter MAC: GF(2^128) Polynomial Hashing</h4>

            <p class="text-text-secondary mb-4">
              The authentication tag is computed using dual polynomial evaluation over the Galois Field GF(2^128). This provides <strong class="text-white">information-theoretic authentication</strong> — mathematically proven unforgeable without the pad.
            </p>

            <!-- How It Works -->
            <div class="bg-bg-card border border-border rounded-xl overflow-hidden mb-6">
              <div class="px-4 py-3 border-b border-border bg-bg-elevated">
                <h5 class="font-semibold text-white">How Wegman-Carter Works</h5>
              </div>
              <div class="p-5 space-y-4">
                <p class="text-text-secondary text-sm">
                  The core idea: treat the message as coefficients of a polynomial, evaluate it at a secret random point <code class="text-brand">r</code>, then mask the result with a one-time pad value <code class="text-success">s</code>.
                </p>

                <!-- Conceptual Flow -->
                <div class="flex flex-col sm:flex-row items-center gap-3 text-sm">
                  <div class="px-4 py-2 bg-bg-elevated rounded-lg border border-border text-center">
                    <div class="text-text-muted text-xs mb-1">Message</div>
                    <div class="font-mono text-white">M = [b₁, b₂, ..., bₙ]</div>
                  </div>
                  <svg class="w-5 h-5 text-text-muted rotate-90 sm:rotate-0 shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3" /></svg>
                  <div class="px-4 py-2 bg-brand/10 rounded-lg border border-brand/30 text-center">
                    <div class="text-text-muted text-xs mb-1">Polynomial</div>
                    <div class="font-mono text-brand-light">P(x) = b₁x^n + b₂x^(n-1) + ...</div>
                  </div>
                  <svg class="w-5 h-5 text-text-muted rotate-90 sm:rotate-0 shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3" /></svg>
                  <div class="px-4 py-2 bg-success/10 rounded-lg border border-success/30 text-center">
                    <div class="text-text-muted text-xs mb-1">Tag</div>
                    <div class="font-mono text-success">P(r) ⊕ s</div>
                  </div>
                </div>

                <!-- Algorithm Steps -->
                <div class="mt-4 space-y-3">
                  <div class="flex items-start gap-3">
                    <span class="flex-shrink-0 w-6 h-6 bg-brand/20 rounded flex items-center justify-center text-brand text-xs font-bold">1</span>
                    <div class="text-sm">
                      <span class="text-white font-medium">Split message into 128-bit blocks:</span>
                      <span class="text-text-secondary"> Each 16-byte chunk becomes a field element.</span>
                    </div>
                  </div>
                  <div class="flex items-start gap-3">
                    <span class="flex-shrink-0 w-6 h-6 bg-brand/20 rounded flex items-center justify-center text-brand text-xs font-bold">2</span>
                    <div class="text-sm">
                      <span class="text-white font-medium">Build polynomial:</span>
                      <span class="text-text-secondary"> Blocks are coefficients: P(x) = b₁·x^n + b₂·x^(n-1) + ... + bₙ·x</span>
                    </div>
                  </div>
                  <div class="flex items-start gap-3">
                    <span class="flex-shrink-0 w-6 h-6 bg-brand/20 rounded flex items-center justify-center text-brand text-xs font-bold">3</span>
                    <div class="text-sm">
                      <span class="text-white font-medium">Evaluate at secret point r:</span>
                      <span class="text-text-secondary"> Compute P(r) in GF(2^128) using Horner's method.</span>
                    </div>
                  </div>
                  <div class="flex items-start gap-3">
                    <span class="flex-shrink-0 w-6 h-6 bg-success/20 rounded flex items-center justify-center text-success text-xs font-bold">4</span>
                    <div class="text-sm">
                      <span class="text-white font-medium">Apply OTP mask:</span>
                      <span class="text-text-secondary"> Tag = P(r) ⊕ s. The mask s is never reused.</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Worked Example -->
            <div class="bg-bg-card border border-border rounded-xl overflow-hidden mb-6">
              <div class="px-4 py-3 border-b border-border bg-bg-elevated">
                <h5 class="font-semibold text-white">Worked Example</h5>
              </div>
              <div class="p-5 space-y-4">
                <p class="text-text-secondary text-sm">
                  Authenticating a 32-byte ciphertext (2 blocks):
                </p>

                <!-- Input -->
                <div class="bg-bg-elevated rounded-lg p-4 space-y-3">
                  <div class="flex flex-wrap items-center gap-2 text-sm">
                    <span class="text-text-muted w-20">Ciphertext:</span>
                    <code class="text-warning font-mono text-xs">A3F1...29F6</code>
                    <span class="text-text-muted">(block 1, 16 bytes)</span>
                    <code class="text-warning font-mono text-xs">6EC4...D8B2</code>
                    <span class="text-text-muted">(block 2, 16 bytes)</span>
                  </div>
                  <div class="flex flex-wrap items-center gap-2 text-sm">
                    <span class="text-text-muted w-20">Auth key:</span>
                    <code class="text-brand font-mono text-xs">r = 7B3A...F912</code>
                    <span class="text-text-muted">(random point)</span>
                    <code class="text-success font-mono text-xs">s = E5C1...8D4A</code>
                    <span class="text-text-muted">(OTP mask)</span>
                  </div>
                </div>

                <!-- Computation -->
                <div class="space-y-2 text-sm">
                  <div class="flex items-center gap-2">
                    <span class="text-text-muted">Step 1:</span>
                    <span class="text-text-secondary">Polynomial P(x) = b₁·x² + b₂·x</span>
                  </div>
                  <div class="flex items-center gap-2">
                    <span class="text-text-muted">Step 2:</span>
                    <span class="text-text-secondary">Horner's method: ((b₁ · r) + b₂) · r</span>
                  </div>
                  <div class="flex items-center gap-2">
                    <span class="text-text-muted">Step 3:</span>
                    <span class="text-text-secondary">P(r) = <code class="text-brand-light font-mono">3D7F...A2E1</code> (GF multiplication)</span>
                  </div>
                  <div class="flex items-center gap-2">
                    <span class="text-text-muted">Step 4:</span>
                    <span class="text-text-secondary">Tag = P(r) ⊕ s = <code class="text-success font-mono">D8BE...2FAB</code></span>
                  </div>
                </div>

                <!-- Final Tag -->
                <div class="bg-success/10 border border-success/30 rounded-lg p-3">
                  <div class="flex items-center gap-2 text-sm">
                    <svg class="w-4 h-4 text-success shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg>
                    <span class="text-success font-medium">128-bit tag:</span>
                    <code class="text-success font-mono text-xs">D8BE...2FAB</code>
                  </div>
                  <p class="text-text-muted text-xs mt-2">ASH uses dual evaluation (r₁, r₂ with s₁, s₂) to produce a 256-bit tag.</p>
                </div>
              </div>
            </div>

            <!-- Why It's Secure -->
            <div class="bg-bg-card border border-border rounded-xl overflow-hidden mb-6">
              <div class="px-4 py-3 border-b border-border bg-bg-elevated">
                <h5 class="font-semibold text-white">Why It's Unforgeable</h5>
              </div>
              <div class="p-5 space-y-3 text-sm text-text-secondary">
                <p>
                  <strong class="text-white">Without knowing r:</strong> An attacker sees only P(r) ⊕ s. The OTP mask s hides P(r) completely. They cannot learn r from a single tag.
                </p>
                <p>
                  <strong class="text-white">To forge a different message M':</strong> They need P'(r) ⊕ s = P(r) ⊕ s ⊕ (P(r) ⊕ P'(r)). But P(r) ⊕ P'(r) is unknown without r.
                </p>
                <p>
                  <strong class="text-white">Probability of guessing:</strong> For a degree-n polynomial in GF(2^128), there are at most n values where P(r) = P'(r). Probability of collision: n/2^128 ≈ 0.
                </p>
              </div>
            </div>

            <!-- Properties Table -->
            <div class="bg-bg-card border border-border rounded-lg overflow-hidden">
              <table class="w-full text-sm">
                <thead>
                  <tr class="border-b border-border bg-bg-elevated">
                    <th class="text-left p-3 text-text-muted font-medium">Property</th>
                    <th class="text-left p-3 text-text-muted font-medium">Value</th>
                  </tr>
                </thead>
                <tbody class="divide-y divide-border">
                  <tr><td class="p-3">Tag size</td><td class="p-3 text-text-secondary">256 bits (32 bytes)</td></tr>
                  <tr><td class="p-3">Auth key</td><td class="p-3 text-text-secondary">64 bytes: r₁ (16) + r₂ (16) + s₁ (16) + s₂ (16)</td></tr>
                  <tr><td class="p-3">Field polynomial</td><td class="p-3 text-text-secondary font-mono text-xs">x^128 + x^7 + x^2 + x + 1</td></tr>
                  <tr><td class="p-3">Forgery probability</td><td class="p-3 text-text-secondary">~2^-128 (negligible)</td></tr>
                  <tr><td class="p-3">Security level</td><td class="p-3 text-text-secondary">Information-theoretic (unconditional)</td></tr>
                </tbody>
              </table>
            </div>

            <InfoBox class="mt-4">
              <p class="text-sm">
                <strong class="text-white">Why dual polynomials?</strong> Using two independent evaluations (r₁, r₂) with separate OTP masks (s₁, s₂) provides 256-bit security. A single polynomial would only give ~2^-64 forgery resistance.
              </p>
            </InfoBox>

            <h4 class="font-medium mt-6 mb-3">Traffic Analysis Protection</h4>

            <p class="text-text-secondary mb-4">
              All messages are padded to <strong class="text-white">minimum 32 bytes</strong> before encryption. Without this, short messages would be distinguishable by size.
            </p>

            <Diagram title="Padding Effect">
{`Without padding (vulnerable to traffic analysis):
  "yes"           → 3 bytes   ┐
  "no"            → 2 bytes   ├─ Distinguishable!
  "I'll be there" → 13 bytes  ┘

With mandatory 32-byte padding:
  "yes"           → 32 bytes  ┐
  "no"            → 32 bytes  ├─ All identical size
  "I'll be there" → 32 bytes  ┘

Padding format: [0x00 marker][2-byte length][content][zero fill to 32]`}
            </Diagram>

            <InfoBox variant="warning" class="mt-4">
              <p class="text-sm">
                <strong>Attack prevented:</strong> Without padding, an adversary observing encrypted message sizes could fingerprint "yes/no" responses, detect typing patterns, or infer conversation topics from message length sequences.
              </p>
            </InfoBox>
          </div>

          <div id="bidirectional" class="mb-8">
            <h3 class="text-xl font-semibold mb-4">Bidirectional Pad Consumption</h3>

            <p class="text-text-secondary mb-4">
              ASH uses a bidirectional consumption model to enable independent messaging by both parties without coordination or collision.
            </p>

            <Diagram title="Pad Consumption Model">
{`Pad:  [████████████████████████████████████████████████████████████████]
       ↑                                                              ↑
       │                                                              │
       Initiator (Alice)                                  Responder (Bob)
       consumes →                                              ← consumes

Example (100-byte pad):
Start:  [░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░]
        0                                                           99

Alice sends 20 bytes:
        [████████████████████░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░]
        0                  19                                       99

Bob sends 30 bytes:
        [████████████████████░░░░░░░░░░░░░░░░░░░░░░██████████████████]
        0                  19                    69                 99

Remaining: 50 bytes (indices 20-69)`}
            </Diagram>

            <div class="bg-bg-card border border-border rounded-lg overflow-hidden mt-4">
              <div class="px-4 py-2 border-b border-border bg-bg-elevated">
                <span class="text-xs font-medium text-text-secondary">Consumption Rules</span>
              </div>
              <ul class="p-4 space-y-2 text-sm text-text-secondary">
                <li>• <strong class="text-white">Initiator (ceremony starter):</strong> Consumes bytes from index 0 forward</li>
                <li>• <strong class="text-white">Responder (ceremony receiver):</strong> Consumes bytes from the end backward</li>
                <li>• <strong class="text-white">No overlap:</strong> The two fronts never collide (pad exhausted when they meet)</li>
                <li>• <strong class="text-white">Independent:</strong> Either party can send without waiting for the other</li>
                <li>• <strong class="text-white">Asymmetric:</strong> Alice can use 20%, Bob can use 80% (or any split)</li>
              </ul>
            </div>

            <h4 class="font-medium mt-6 mb-3">Forward Secrecy</h4>
            <p class="text-text-secondary text-sm">
              After encryption, the used pad bytes are securely zeroed. Even if an attacker later compromises the device, they cannot decrypt messages encrypted with already-destroyed key material.
            </p>
          </div>

          <div id="message-types" class="mb-8">
            <h3 class="text-xl font-semibold mb-4">Message Types</h3>

            <p class="text-text-secondary mb-4">
              ASH v1 supports two message types. Both are encrypted identically — the type is determined by content structure after decryption.
            </p>

            <div class="bg-bg-card border border-border rounded-lg overflow-hidden">
              <table class="w-full text-sm">
                <thead>
                  <tr class="border-b border-border bg-bg-elevated">
                    <th class="text-left p-3 text-text-muted font-medium">Type</th>
                    <th class="text-left p-3 text-text-muted font-medium">Format</th>
                    <th class="text-left p-3 text-text-muted font-medium">Size</th>
                  </tr>
                </thead>
                <tbody class="divide-y divide-border">
                  <tr>
                    <td class="p-3 font-medium">Text</td>
                    <td class="p-3 text-text-secondary">UTF-8 string</td>
                    <td class="p-3 text-text-secondary">1 byte per character (ASCII) or more (Unicode)</td>
                  </tr>
                  <tr>
                    <td class="p-3 font-medium">Location</td>
                    <td class="p-3 text-text-secondary font-mono text-xs">lat,lng (6 decimal places)</td>
                    <td class="p-3 text-text-secondary">~25 bytes (e.g., "37.774929,-122.419418")</td>
                  </tr>
                </tbody>
              </table>
            </div>

            <InfoBox variant="warning" class="mt-4">
              <p class="text-sm">
                <strong>No media support:</strong> Photos and videos would exhaust pad capacity quickly. ASH intentionally supports only text and one-shot location sharing. This is a security feature, not a limitation.
              </p>
            </InfoBox>

            <h4 class="font-medium mt-6 mb-3">Message Lifecycle</h4>
            <Diagram title="Message Flow">
{`Sender                      Relay (RAM)                     Receiver
  │                              │                              │
  │  1. Pad message to 32 bytes  │                              │
  │  2. Consume 64+N pad bytes   │                              │
  │  3. OTP encrypt              │                              │
  │  4. Compute Wegman-Carter tag│                              │
  │  5. Assemble frame           │                              │
  │                              │                              │
  │  POST /v1/messages ──────────►  (store frame, start TTL)    │
  │  ◄── {blob_id} ──────────────│                              │
  │                              │                              │
  │                              │  SSE: new message ───────────►
  │                              │                 1. Verify tag │
  │                              │                 2. Decrypt    │
  │                              │                 3. Unpad      │
  │                              │  ◄── POST /v1/ack ───────────│
  │  ◄── SSE: delivered ─────────│  (delete from RAM)           │
  │                              │                              │
  │  6. Zero used pad bytes      │                              │`}
            </Diagram>
          </div>
        </section>

        <!-- Token Derivation -->
        <section id="tokens">
          <h2 class="text-2xl font-bold mb-6 pb-2 border-b border-border">Authorization Token Derivation</h2>

          <p class="text-text-secondary mb-6">
            Authorization tokens enable API authentication without accounts or identity. Both parties derive the same tokens from the shared pad.
          </p>

          <div class="bg-bg-card border border-border rounded-lg overflow-hidden">
            <table class="w-full text-sm">
              <thead>
                <tr class="border-b border-border bg-bg-elevated">
                  <th class="text-left p-3 text-text-muted font-medium">Token</th>
                  <th class="text-left p-3 text-text-muted font-medium">Pad Bytes</th>
                  <th class="text-left p-3 text-text-muted font-medium">Purpose</th>
                </tr>
              </thead>
              <tbody class="divide-y divide-border">
                <tr><td class="p-3 font-medium">Conversation ID</td><td class="p-3 text-text-secondary font-mono text-xs">0-31</td><td class="p-3 text-text-secondary">Identifies the conversation on the relay</td></tr>
                <tr><td class="p-3 font-medium">Auth Token</td><td class="p-3 text-text-secondary font-mono text-xs">32-95</td><td class="p-3 text-text-secondary">Authenticates API requests</td></tr>
                <tr><td class="p-3 font-medium">Burn Token</td><td class="p-3 text-text-secondary font-mono text-xs">96-159</td><td class="p-3 text-text-secondary">Required for burn operations</td></tr>
              </tbody>
            </table>
          </div>

          <h3 class="text-lg font-semibold mt-6 mb-3">Derivation Process</h3>
          <ol class="list-decimal list-inside text-text-secondary space-y-1 text-sm">
            <li>Extract specific byte ranges from pad</li>
            <li>XOR-fold to 32-byte output</li>
            <li>Apply domain separation constant</li>
            <li>Multiple mixing rounds for diffusion</li>
            <li>Encode as 64-character lowercase hex</li>
          </ol>

          <h3 class="text-lg font-semibold mt-6 mb-3">Security Properties</h3>
          <ul class="list-disc list-inside text-text-secondary space-y-1 text-sm">
            <li><strong class="text-white">Deterministic:</strong> Same pad produces same tokens on both devices</li>
            <li><strong class="text-white">Unpredictable:</strong> Without pad, tokens cannot be computed or forged</li>
            <li><strong class="text-white">Separated:</strong> Different tokens for different operations</li>
            <li><strong class="text-white">Backend-safe:</strong> Backend stores only hash(token)</li>
          </ul>
        </section>

        <!-- Trust Boundaries -->
        <section id="trust">
          <h2 class="text-2xl font-bold mb-6 pb-2 border-b border-border">Trust Boundaries</h2>

          <p class="text-text-secondary mb-6">
            ASH explicitly defines what each component is trusted to do. This is fundamental to the security model.
          </p>

          <div class="bg-bg-card border border-border rounded-lg overflow-hidden">
            <table class="w-full text-sm">
              <thead>
                <tr class="border-b border-border bg-bg-elevated">
                  <th class="text-left p-3 text-text-muted font-medium">Component</th>
                  <th class="text-left p-3 text-text-muted font-medium">Trust Level</th>
                  <th class="text-left p-3 text-text-muted font-medium">Rationale</th>
                </tr>
              </thead>
              <tbody class="divide-y divide-border">
                <tr><td class="p-3 font-medium">ash-core</td><td class="p-3"><span class="px-2 py-0.5 bg-success/20 text-success rounded text-xs">Trusted</span></td><td class="p-3 text-text-secondary">Cryptographic authority, minimal surface</td></tr>
                <tr><td class="p-3 font-medium">iOS App</td><td class="p-3"><span class="px-2 py-0.5 bg-warning/20 text-warning rounded text-xs">Partially</span></td><td class="p-3 text-text-secondary">Handles UI, invokes core, stores keys</td></tr>
                <tr><td class="p-3 font-medium">Backend</td><td class="p-3"><span class="px-2 py-0.5 bg-danger/20 text-danger rounded text-xs">Untrusted</span></td><td class="p-3 text-text-secondary">Never sees plaintext or keys</td></tr>
                <tr><td class="p-3 font-medium">Network</td><td class="p-3"><span class="px-2 py-0.5 bg-danger/20 text-danger rounded text-xs">Untrusted</span></td><td class="p-3 text-text-secondary">All traffic is encrypted blobs</td></tr>
                <tr><td class="p-3 font-medium">User</td><td class="p-3"><span class="px-2 py-0.5 bg-success/20 text-success rounded text-xs">Trusted</span></td><td class="p-3 text-text-secondary">Must perform ceremony correctly</td></tr>
              </tbody>
            </table>
          </div>

          <InfoBox class="mt-6">
            <p class="text-sm">
              <strong class="text-white">Design consequence:</strong> ASH deliberately avoids background synchronization, convenience features, user accounts, key recovery, cloud storage, and analytics. All constraints are intentional.
            </p>
          </InfoBox>
        </section>

        <!-- Footer -->
        <div class="pt-8 border-t border-border">
          <p class="text-text-muted text-sm text-center">
            For security analysis, see <a href="/security" class="text-brand hover:text-brand-light">Security Model</a>. For ethical considerations, see <a href="/ethics" class="text-brand hover:text-brand-light">Ethics Statement</a>.
          </p>
        </div>
      </article>
    </div>
  </div>
</Layout>

<style>
  .prose-content h2 {
    scroll-margin-top: 6rem;
  }
  .prose-content h3 {
    scroll-margin-top: 6rem;
  }
</style>
